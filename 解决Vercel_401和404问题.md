# 解决 Vercel 401 和 404 问题

## 问题总结

### 1. 401 Unauthorized（上传图片时）
- **原因**：Blob Storage token 未配置或无效
- **影响**：文件上传失败

### 2. 404 Not Found（API 路由）
- **原因**：Vercel 项目根目录配置可能不正确
- **影响**：所有 API 请求都返回 404

### 3. CORS 错误
- **原因**：因为返回 404，所以没有 CORS 头
- **影响**：前端无法访问 API

### 4. 前端环境检测问题
- **原因**：代码已修复但可能未部署
- **影响**：`frontend/index.html` 仍尝试连接 localhost

## 已完成的修复

### 1. 添加 Blob Storage 错误回退机制

当 Blob Storage 返回 401 时，自动回退到 `/tmp` 存储：

```javascript
// backend/server.js
try {
  // 尝试上传到 Blob Storage
  const blob = await put(blobPath, file.buffer, {
    access: 'public',
    contentType: file.mimetype,
    token: BLOB_TOKEN
  });
  return blob.url;
} catch (error) {
  console.error('上传到 Blob Storage 失败:', error);
  // 回退到本地存储（/tmp）
  const uniqueName = `${uuidv4()}-${file.originalname}`;
  const filePath = path.join(STORAGE_BASE, 'uploads', fileType, uniqueName);
  fs.writeFileSync(filePath, file.buffer);
  return `/uploads/${fileType}/${uniqueName}`;
}
```

### 2. 修复前端环境检测

`frontend/index.html` 现在会自动检测环境并切换 API 地址。

## 需要手动操作

### 步骤 1：检查 Vercel 项目根目录

1. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
2. 进入项目 `backend-topaz-zeta-46`
3. 进入 **Settings** → **General**
4. 找到 **Root Directory** 设置
5. **必须设置为 `backend`**
6. 保存并重新部署

### 步骤 2：配置 Blob Storage Token（可选，但推荐）

如果希望使用 Blob Storage（持久化存储），需要：

1. 在 Vercel Dashboard 中
2. 进入 **Settings** → **Environment Variables**
3. 添加环境变量：
   - **Name**: `BLOB_READ_WRITE_TOKEN`
   - **Value**: 你的 Blob Storage token（以 `vercel_blob_rw_` 开头）
4. 保存并重新部署

**注意**：如果不配置 Blob Storage token，系统会自动回退到 `/tmp` 存储（文件在重启后会丢失，但可以正常工作）。

### 步骤 3：推送代码到 GitHub

代码已修复并提交到本地仓库。由于网络问题，需要手动推送：

```bash
git push
```

### 步骤 4：等待部署完成

1. Vercel 会自动检测 GitHub 推送并重新部署
2. 或手动在 Vercel Dashboard 中点击 "Redeploy"
3. 等待 1-2 分钟

### 步骤 5：验证部署

部署完成后，访问：

- `https://backend-topaz-zeta-46.vercel.app/api` - 应该返回 JSON，不再 404
- `https://backend-topaz-zeta-46.vercel.app/api/courses` - 应该返回课程列表
- `https://backend-topaz-zeta-46.vercel.app/api/levels` - 应该返回关卡列表

### 步骤 6：清除浏览器缓存

访问前端页面时：

1. 按 `Ctrl + Shift + R` 强制刷新
2. 或按 `F12` → Network → 勾选 "Disable cache"

## 验证清单

修复后，应该满足：

- [ ] `https://backend-topaz-zeta-46.vercel.app/api` 返回 JSON（不是 404）
- [ ] `https://wangkainan2021.github.io/ai-course/frontend/admin.html` 可以加载关卡列表
- [ ] `https://wangkainan2021.github.io/ai-course/frontend/index.html` 可以加载课程
- [ ] 上传图片不再返回 401（即使没有 Blob Storage token，也会回退到 /tmp 存储）
- [ ] 控制台不再显示 CORS 错误

## 如果仍然有问题

### 检查 Vercel 部署日志

1. 在 Vercel Dashboard 中查看最新的部署
2. 查看 **Build Logs** 和 **Function Logs**
3. 检查是否有错误信息

### 检查环境变量

在 Vercel Dashboard 中确认：
- `BLOB_READ_WRITE_TOKEN` 是否已配置（可选）
- 其他必要的环境变量是否已设置

### 手动重新部署

如果自动部署失败：
1. 在 Vercel Dashboard 中
2. 找到最新的部署
3. 点击 "Redeploy"

## 临时解决方案

如果 Vercel 部署一直有问题，可以：

1. **使用本地后端**：
   - 运行 `cd backend && npm start`
   - 前端会自动检测并使用本地 API

2. **检查网络连接**：
   - 确保可以访问 GitHub 和 Vercel
   - 尝试使用 VPN 或更换网络

## 下一步

修复后，系统应该可以正常工作。如果还有问题，请告诉我：
1. Vercel Dashboard 中的 Root Directory 设置是什么？
2. 部署日志中有什么错误？
3. 是否配置了 Blob Storage token？
