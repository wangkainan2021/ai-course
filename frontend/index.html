<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå­¦ä¹ è¯¾ç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'SimHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }


        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .steps-indicator {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            gap: 20px;
            flex-wrap: wrap;
        }

        .step-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: bold;
            font-size: 20px;
        }

        .step-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .step-item.completed {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            padding: 40px;
            min-height: 500px;
        }

        .level-container {
            display: none;
            animation: fadeIn 0.5s;
        }

        .level-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å›¾ç‰‡å…³å¡æ ·å¼ */
        .image-gallery {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 30px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
        }

        .image-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .gallery-image.active {
            display: block;
        }

        .gallery-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
        }

        .gallery-nav-button.prev {
            left: 20px;
        }

        .gallery-nav-button.next {
            right: 20px;
        }

        .gallery-indicators {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .gallery-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
        }

        .gallery-indicator.active {
            background: #667eea;
        }

        /* è§†é¢‘å…³å¡æ ·å¼ */
        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            position: relative;
            padding-top: 56.25%;
        }

        .video-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
        }

        /* Canvaså…³å¡æ ·å¼ */
        .canvas-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 400px;
        }

        .canvas-wrapper {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* æ–‡æœ¬è¯´æ˜åŒºåŸŸ */
        .text-area {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
        }

        .text-area h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .text-content {
            color: #555;
            font-size: 16px;
            line-height: 1.8;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 60px 20px;
            color: #c33;
            background: #fee;
            border-radius: 12px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .content-area {
                padding: 20px;
            }

            .steps-indicator {
                gap: 10px;
            }

            .step-item {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="steps-indicator" id="stepsIndicator">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-area" id="contentArea">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        // è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒå¹¶è®¾ç½®APIåœ°å€
        // ç¯å¢ƒæ£€æµ‹ï¼šåªæœ‰åœ¨ localhost/127.0.0.1 ä¸”ä¸æ˜¯ file:// åè®®æ—¶æ‰ä½¿ç”¨æœ¬åœ° API
        // file:// åè®®ï¼ˆç›´æ¥æ‰“å¼€æœ¬åœ°æ–‡ä»¶ï¼‰ä½¿ç”¨çº¿ä¸Š API
        const hostname = window.location.hostname;
        const isLocal = (hostname === 'localhost' || hostname === '127.0.0.1') && 
                       window.location.protocol !== 'file:';
        
        // çº¿ä¸Šåç«¯åœ°å€
        const PRODUCTION_API_URL = 'https://backend-topaz-zeta-46.vercel.app/api';
        
        const API_BASE_URL = isLocal 
            ? 'http://localhost:3000/api' 
            : PRODUCTION_API_URL;
        
        console.log('å½“å‰ç¯å¢ƒ:', isLocal ? 'æœ¬åœ°å¼€å‘' : 'çº¿ä¸Šç”Ÿäº§');
        console.log('APIåœ°å€:', API_BASE_URL);
        
        let currentCourse = null;
        let currentLevelIndex = 0;
        let currentImageIndex = 0;

        // åˆå§‹åŒ–
        async function init() {
            try {
                // è·å–è¯¾ç¨‹åˆ—è¡¨ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªè¯¾ç¨‹ï¼‰
                const coursesRes = await fetch(`${API_BASE_URL}/courses`);
                const coursesData = await coursesRes.json();
                
                if (coursesData.success && coursesData.data.length > 0) {
                    currentCourse = coursesData.data[0];
                    loadCourse(currentCourse);
                } else {
                    showError('æš‚æ— è¯¾ç¨‹ï¼Œè¯·å…ˆåˆ›å»ºè¯¾ç¨‹');
                }
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showError('åŠ è½½è¯¾ç¨‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ');
            }
        }

        // åŠ è½½è¯¾ç¨‹
        async function loadCourse(course) {
            if (!course || !course.levelIds || course.levelIds.length === 0) {
                showError('è¯¾ç¨‹ä¸­æ²¡æœ‰å…³å¡');
                return;
            }

            // ç”Ÿæˆæ­¥éª¤æŒ‡ç¤ºå™¨
            generateStepsIndicator(course.levelIds.length);

            // åŠ è½½ç¬¬ä¸€ä¸ªå…³å¡
            await loadLevel(0);
        }

        // ç”Ÿæˆæ­¥éª¤æŒ‡ç¤ºå™¨
        function generateStepsIndicator(count) {
            const indicator = document.getElementById('stepsIndicator');
            indicator.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const step = document.createElement('div');
                step.className = 'step-item' + (i === 0 ? ' active' : '');
                step.textContent = i + 1;
                step.onclick = () => goToLevel(i);
                indicator.appendChild(step);
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šå…³å¡
        async function goToLevel(index) {
            if (!currentCourse || index < 0 || index >= currentCourse.levelIds.length) {
                return;
            }

            currentLevelIndex = index;
            await loadLevel(index);
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.querySelectorAll('.step-item').forEach((item, i) => {
                item.classList.remove('active', 'completed');
                if (i < index) {
                    item.classList.add('completed');
                } else if (i === index) {
                    item.classList.add('active');
                }
            });
        }

        // åŠ è½½å…³å¡
        async function loadLevel(index) {
            const levelId = currentCourse.levelIds[index];
            
            try {
                const levelRes = await fetch(`${API_BASE_URL}/levels/${levelId}`);
                const levelData = await levelRes.json();
                
                if (levelData.success) {
                    renderLevel(levelData.data);
                } else {
                    showError('åŠ è½½å…³å¡å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å…³å¡å¤±è´¥:', error);
                showError('åŠ è½½å…³å¡å¤±è´¥');
            }
        }

        // æ¸²æŸ“å…³å¡
        async function renderLevel(level) {
            const contentArea = document.getElementById('contentArea');
            
            let html = '';
            let canvasCode = null;
            let blobUrl = null;
            
            if (level.type === 'image') {
                html = renderImageLevel(level);
            } else if (level.type === 'video') {
                html = renderVideoLevel(level);
            } else if (level.type === 'canvas') {
                const result = await renderCanvasLevel(level);
                html = result.html;
                canvasCode = result.code;
                blobUrl = result.blobUrl; // ä¿å­˜blob URLä»¥ä¾¿åç»­æ¸…ç†
            } else if (level.type === 'quiz') {
                html = renderQuizLevel(level);
            }
            
            contentArea.innerHTML = html;
            
            // å¦‚æœæ˜¯Canvaså…³å¡ä¸”æ˜¯HTMLæ–‡æ¡£ï¼ˆä½¿ç”¨iframeï¼‰ï¼Œä¸éœ€è¦æ‰§è¡Œä»£ç 
            if (level.type === 'canvas' && blobUrl) {
                // HTMLæ–‡æ¡£å·²ç»åœ¨iframeä¸­åŠ è½½ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
                console.log('HTMLæ–‡æ¡£å·²åœ¨iframeä¸­åŠ è½½');
                return;
            }
            
            // å¦‚æœæ˜¯Canvaså…³å¡ï¼Œæ‰§è¡Œä»£ç 
            if (level.type === 'canvas' && canvasCode) {
                const canvasId = `canvas-${level.id}`;
                // ä½¿ç”¨æ›´å¯é çš„æ–¹å¼ç­‰å¾…canvaså…ƒç´ å‡†å¤‡å¥½
                const executeCanvasCode = () => {
                    const canvas = document.getElementById(canvasId);
                    if (canvas) {
                        try {
                            const ctx = canvas.getContext('2d');
                            
                            // æ¸…ç†ä»£ç ï¼šç§»é™¤å¯èƒ½çš„BOMæ ‡è®°å’Œå¤šä½™çš„ç©ºç™½
                            let cleanCode = canvasCode.trim();
                            
                            // è¾“å‡ºè°ƒè¯•ä¿¡æ¯
                            console.log('å‡†å¤‡æ‰§è¡ŒCanvasä»£ç ï¼Œä»£ç é•¿åº¦:', cleanCode.length);
                            console.log('ä»£ç å‰100å­—ç¬¦:', cleanCode.substring(0, 100));
                            
                            // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥è€Œä¸æ˜¯æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œé¿å…ä»£ç ä¸­çš„ç‰¹æ®Šå­—ç¬¦å¯¼è‡´è¯­æ³•é”™è¯¯
                            // å°†ä»£ç ä½œä¸ºFunctionæ„é€ å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°ï¼ˆå‡½æ•°ä½“ï¼‰
                            // ä½¿ç”¨æ•°ç»„æ‹¼æ¥æ¥æ„å»ºå‡½æ•°ä½“å­—ç¬¦ä¸²ï¼Œé¿å…æ¨¡æ¿å­—ç¬¦ä¸²çš„é—®é¢˜
                            const functionBodyParts = [
                                'try {',
                                cleanCode,
                                '} catch (e) {',
                                '    console.error(\'ä»£ç å†…éƒ¨é”™è¯¯:\', e);',
                                '    throw e;',
                                '}'
                            ];
                            
                            // åˆ›å»ºå‡½æ•°ï¼Œcanvaså’Œctxä½œä¸ºå‚æ•°
                            const scopeFunction = new Function('canvas', 'ctx', functionBodyParts.join('\n'));
                            
                            // æ‰§è¡Œä»£ç 
                            scopeFunction(canvas, ctx);
                            
                            console.log('Canvasä»£ç æ‰§è¡ŒæˆåŠŸ');
                        } catch (error) {
                            console.error('Canvasä»£ç æ‰§è¡Œé”™è¯¯:', error);
                            console.error('é”™è¯¯åç§°:', error.name);
                            console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                            console.error('é”™è¯¯å †æ ˆ:', error.stack);
                            console.error('ä»£ç å‰200å­—ç¬¦:', canvasCode.substring(0, 200));
                            console.error('å®Œæ•´ä»£ç :', canvasCode);
                            
                            // å°è¯•æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                            try {
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = '#f0f0f0';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                ctx.fillStyle = '#c33';
                                ctx.font = '14px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                                const errorMsg = error.name + ': ' + error.message;
                                const errorLines = errorMsg.match(/.{1,50}/g) || [errorMsg];
                                
                                // å¦‚æœé”™è¯¯ä¿¡æ¯å¤ªé•¿ï¼Œåªæ˜¾ç¤ºå‰å‡ è¡Œ
                                const maxLines = 5;
                                const displayLines = errorLines.slice(0, maxLines);
                                
                                displayLines.forEach((line, i) => {
                                    ctx.fillText(line, canvas.width / 2, canvas.height / 2 - (displayLines.length - 1) * 12 + i * 24);
                                });
                                
                                if (errorLines.length > maxLines) {
                                    ctx.fillText('...', canvas.width / 2, canvas.height / 2 + (maxLines - 1) * 12 + 24);
                                }
                                
                                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                                ctx.fillStyle = '#666';
                                ctx.font = '12px Arial';
                                ctx.fillText('è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯', canvas.width / 2, canvas.height / 2 + (maxLines + 1) * 12 + 24);
                            } catch (renderError) {
                                console.error('æ¸²æŸ“é”™è¯¯ä¿¡æ¯å¤±è´¥:', renderError);
                            }
                        }
                    } else {
                        // å¦‚æœcanvasè¿˜æ²¡å‡†å¤‡å¥½ï¼Œå†ç­‰ä¸€ä¼šå„¿
                        setTimeout(executeCanvasCode, 50);
                    }
                };
                
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²æ›´æ–°
                setTimeout(executeCanvasCode, 200);
            }
            
            // å¦‚æœæ˜¯å›¾ç‰‡å…³å¡ï¼Œåˆå§‹åŒ–å›¾ç‰‡åˆ‡æ¢åŠŸèƒ½
            if (level.type === 'image' && level.images && level.images.length > 0) {
                initImageGallery(level);
            }
        }

        // æ¸²æŸ“é€‰æ‹©é¢˜å…³å¡
        function renderQuizLevel(level) {
            const quiz = level.quiz || { questions: [] };
            const questions = quiz.questions || [];

            if (!questions.length) {
                return `
                    <div class="level-container active">
                        <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${level.title || 'é€‰æ‹©é¢˜å…³å¡'}</h2>
                        <div class="error">æ­¤é€‰æ‹©é¢˜å…³å¡æ²¡æœ‰é¢˜ç›®</div>
                    </div>
                `;
            }

            const qHtml = questions.map((q, qi) => {
                const type = q.type || 'single';
                const inputType = type === 'multi' ? 'checkbox' : 'radio';
                const options = q.options || [];
                const optsHtml = options.map((o, oi) => {
                    const id = `q${qi}_o${oi}`;
                    return `
                        <label for="${id}" style="display:flex; gap:10px; align-items:flex-start; padding:10px; border:1px solid #e5e7eb; border-radius:10px; margin:10px 0; cursor:pointer; background:#fff;">
                            <input id="${id}" name="q${qi}" type="${inputType}" value="${oi}" style="margin-top:3px;">
                            <span>${escapeHtml(o.text || '')}</span>
                        </label>
                    `;
                }).join('');

                return `
                    <div class="quiz-question" data-qi="${qi}" style="background:#f8f9fa; border-radius:12px; padding:16px; margin:16px 0;">
                        <div style="font-weight:700; margin-bottom:10px;">${qi + 1}. ${escapeHtml(q.prompt || '')}</div>
                        <div class="quiz-options">${optsHtml}</div>
                        <div class="quiz-feedback" style="display:none; margin-top:12px; padding:10px; border-radius:10px;"></div>
                    </div>
                `;
            }).join('');

            // æŠŠé¢˜åº“ä¸´æ—¶æŒ‚åˆ°windowï¼Œä¾›æäº¤æŒ‰é’®åˆ¤é¢˜
            window.__currentQuiz = { levelId: level.id, quiz };

            return `
                <div class="level-container active">
                    <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${escapeHtml(level.title || 'é€‰æ‹©é¢˜å…³å¡')}</h2>
                    <p class="section-description" style="text-align: center; color: #666; margin-bottom: 20px;">${escapeHtml(level.description || '')}</p>

                    <div style="max-width: 900px; margin: 0 auto;">
                        ${qHtml}
                        <div style="text-align:center; margin-top: 20px;">
                            <button onclick="submitQuiz()" style="background:#667eea; color:#fff; border:none; padding:12px 18px; border-radius:12px; cursor:pointer; font-weight:700;">
                                æäº¤ç­”æ¡ˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // æäº¤å¹¶åˆ¤é¢˜
        window.submitQuiz = function() {
            const payload = window.__currentQuiz;
            if (!payload || !payload.quiz) return;
            const questions = payload.quiz.questions || [];

            questions.forEach((q, qi) => {
                const type = q.type || 'single';
                const options = q.options || [];
                const correct = options.map((o, oi) => (o && o.correct === true ? oi : null)).filter(v => v !== null);

                const selected = Array.from(document.querySelectorAll(`input[name="q${qi}"]:checked`)).map(el => Number(el.value));

                const isCorrect = (type === 'multi')
                    ? (selected.length === correct.length && selected.every(v => correct.includes(v)))
                    : (selected.length === 1 && correct.includes(selected[0]));

                const wrap = document.querySelector(`.quiz-question[data-qi="${qi}"] .quiz-feedback`);
                if (!wrap) return;
                wrap.style.display = 'block';
                wrap.style.border = isCorrect ? '1px solid #86efac' : '1px solid #fca5a5';
                wrap.style.background = isCorrect ? '#dcfce7' : '#fee2e2';
                const exp = q.explanation ? `<div style="margin-top:8px; color:#374151;"><strong>è§£æï¼š</strong>${escapeHtml(q.explanation)}</div>` : '';
                const correctLabels = correct.map(idx => options[idx] ? options[idx].text : '').filter(Boolean).map(escapeHtml).join('ã€');
                const selectedRationales = selected
                    .map(idx => options[idx] && options[idx].rationale ? options[idx].rationale : '')
                    .filter(Boolean)
                    .map(r => `<div style="margin-top:6px; color:#374151;"><strong>ä½ é€‰çš„ç†ç”±ï¼š</strong>${escapeHtml(r)}</div>`)
                    .join('');
                const hint = q.hint ? `<div style="margin-top:8px; color:#6b7280;"><strong>æç¤ºï¼š</strong>${escapeHtml(q.hint)}</div>` : '';
                wrap.innerHTML = `
                    <div style="font-weight:700; color:${isCorrect ? '#166534' : '#991b1b'};">
                        ${isCorrect ? 'æ­£ç¡®' : 'ä¸æ­£ç¡®'}ï¼ˆæ­£ç¡®ç­”æ¡ˆï¼š${correctLabels || 'æœªæ ‡æ³¨'}ï¼‰
                    </div>
                    ${selectedRationales}
                    ${exp}
                    ${hint}
                `;
            });
        };

        // æ¸²æŸ“å›¾ç‰‡å…³å¡
        function renderImageLevel(level) {
            const images = level.images || [];
            const texts = level.texts || [];
            
            // æ„å»ºå›¾ç‰‡URLï¼šå¦‚æœæ˜¯å®Œæ•´URLï¼ˆBlob Storageï¼‰ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™æ‹¼æ¥APIåœ°å€
            const getImageUrl = (imgPath) => {
                if (!imgPath) return '';
                // å¦‚æœå·²ç»æ˜¯å®Œæ•´URLï¼ˆhttp:// æˆ– https://ï¼‰ï¼Œç›´æ¥è¿”å›
                if (imgPath.startsWith('http://') || imgPath.startsWith('https://')) {
                    return imgPath;
                }
                // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ„å»ºå®Œæ•´URL
                if (isLocal) {
                    return `http://localhost:3000${imgPath}`;
                } else {
                    // Vercelç¯å¢ƒï¼šå¦‚æœæ˜¯ /uploads/ å¼€å¤´ï¼Œé€šè¿‡APIæä¾›ï¼›å¦åˆ™å¯èƒ½æ˜¯Blob URL
                    if (imgPath.startsWith('/uploads/')) {
                        return `${API_BASE_URL}${imgPath}`;
                    }
                    return `${API_BASE_URL.replace('/api', '')}${imgPath}`;
                }
            };
            
            let imagesHtml = images.map((img, index) => 
                `<img src="${getImageUrl(img)}" alt="å›¾ç‰‡${index + 1}" class="gallery-image ${index === 0 ? 'active' : ''}" data-index="${index}" onerror="console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', '${img}'); this.style.display='none';">`
            ).join('');
            
            let indicatorsHtml = images.map((_, index) => 
                `<div class="gallery-indicator ${index === 0 ? 'active' : ''}" onclick="goToImage(${index})"></div>`
            ).join('');
            
            return `
                <div class="level-container active">
                    <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${level.title || 'å›¾ç‰‡å…³å¡'}</h2>
                    <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${level.description || ''}</p>
                    
                    <div class="image-gallery">
                        <div class="image-wrapper">
                            ${imagesHtml}
                        </div>
                        ${images.length > 1 ? `
                            <button class="gallery-nav-button prev" onclick="previousImage()">â€¹</button>
                            <button class="gallery-nav-button next" onclick="nextImage()">â€º</button>
                        ` : ''}
                    </div>
                    
                    ${images.length > 1 ? `<div class="gallery-indicators">${indicatorsHtml}</div>` : ''}
                    
                    <div class="text-area">
                        <h3>å›¾ç‰‡è¯´æ˜</h3>
                        <div class="text-content" id="imageText">${texts[0] || ''}</div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“è§†é¢‘å…³å¡
        function renderVideoLevel(level) {
            const videoUrl = level.videoUrl || '';
            
            // åˆ¤æ–­æ˜¯å¦æ˜¯å¤–éƒ¨è§†é¢‘é“¾æ¥ï¼ˆBç«™ã€YouTube ç­‰ï¼‰
            const isExternalVideo = videoUrl.startsWith('http://') || videoUrl.startsWith('https://');
            const isBilibili = videoUrl.includes('bilibili.com');
            const isYouTube = videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be');
            
            let videoHtml = '';
            
            if (isBilibili) {
                // Bç«™è§†é¢‘ï¼šæå– BV å·å¹¶è½¬æ¢ä¸ºåµŒå…¥æ ¼å¼
                const bvidMatch = videoUrl.match(/BV[a-zA-Z0-9]+/);
                if (bvidMatch) {
                    const bvid = bvidMatch[0];
                    videoHtml = `
                        <iframe 
                            src="//player.bilibili.com/player.html?bvid=${bvid}&page=1&high_quality=1&autoplay=0" 
                            scrolling="no" 
                            border="0" 
                            frameborder="no" 
                            framespacing="0" 
                            allowfullscreen="true"
                            style="width: 100%; height: 100%;">
                        </iframe>
                    `;
                } else {
                    videoHtml = `<p style="color: #c33; text-align: center; padding: 20px;">æ— æ³•è§£æ Bç«™è§†é¢‘é“¾æ¥ï¼Œè¯·æ£€æŸ¥ URL æ ¼å¼</p>`;
                }
            } else if (isYouTube) {
                // YouTube è§†é¢‘ï¼šæå–è§†é¢‘ ID å¹¶è½¬æ¢ä¸ºåµŒå…¥æ ¼å¼
                let videoId = '';
                const youtubeMatch = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
                if (youtubeMatch) {
                    videoId = youtubeMatch[1];
                }
                if (videoId) {
                    videoHtml = `
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            style="width: 100%; height: 100%;">
                        </iframe>
                    `;
                } else {
                    videoHtml = `<p style="color: #c33; text-align: center; padding: 20px;">æ— æ³•è§£æ YouTube è§†é¢‘é“¾æ¥ï¼Œè¯·æ£€æŸ¥ URL æ ¼å¼</p>`;
                }
            } else if (isExternalVideo) {
                // å…¶ä»–å¤–éƒ¨è§†é¢‘é“¾æ¥ï¼šç›´æ¥ä½¿ç”¨ video æ ‡ç­¾
                videoHtml = `
                    <video controls style="width: 100%; height: 100%;">
                        <source src="${videoUrl}" type="video/mp4">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                    </video>
                `;
            } else {
                // æœ¬åœ°è§†é¢‘ï¼šæ„å»ºå®Œæ•´ URL
                const fullVideoUrl = videoUrl ? `${API_BASE_URL.replace('/api', '')}${videoUrl}` : '';
                videoHtml = `
                    <video controls style="width: 100%; height: 100%;">
                        <source src="${fullVideoUrl}" type="video/mp4">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                    </video>
                `;
            }
            
            return `
                <div class="level-container active">
                    <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${escapeHtml(level.title || 'è§†é¢‘å…³å¡')}</h2>
                    <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${escapeHtml(level.description || '')}</p>
                    
                    <div class="video-container">
                        <div class="video-wrapper">
                            ${videoHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“Canvaså…³å¡
        async function renderCanvasLevel(level) {
            let code = level.code || '';
            
            // å¦‚æœæœ‰ä»£ç URLï¼Œä¼˜å…ˆåŠ è½½ä»£ç æ–‡ä»¶
            if (level.codeUrl) {
                try {
                    const codeRes = await fetch(`${API_BASE_URL.replace('/api', '')}${level.codeUrl}`);
                    if (codeRes.ok) {
                        const loadedCode = await codeRes.text();
                        if (loadedCode && loadedCode.trim()) {
                            code = loadedCode;
                        }
                    } else {
                        console.warn('åŠ è½½ä»£ç æ–‡ä»¶å¤±è´¥ï¼ŒçŠ¶æ€ç :', codeRes.status);
                    }
                } catch (error) {
                    console.error('åŠ è½½ä»£ç å¤±è´¥:', error);
                    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨level.code
                    if (!code && level.code) {
                        code = level.code;
                    }
                }
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ä»£ç ï¼Œæ˜¾ç¤ºé”™è¯¯
            if (!code || !code.trim()) {
                console.error('Canvaså…³å¡æ²¡æœ‰ä»£ç å†…å®¹');
                return {
                    html: `
                        <div class="level-container active">
                            <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${level.title || 'Canvaså…³å¡'}</h2>
                            <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${level.description || ''}</p>
                            <div class="error" style="text-align: center; padding: 40px;">
                                <p>âš ï¸ Canvaså…³å¡ä»£ç æœªæ‰¾åˆ°æˆ–ä¸ºç©º</p>
                                <p style="margin-top: 10px; font-size: 14px; color: #666;">è¯·æ£€æŸ¥å…³å¡é…ç½®æˆ–é‡æ–°ä¸Šä¼ ä»£ç </p>
                            </div>
                        </div>
                    `,
                    code: null
                };
            }
            
            // æ£€æµ‹ä»£ç æ˜¯å¦æ˜¯å®Œæ•´çš„HTMLæ–‡æ¡£
            const isHTMLDocument = code.trim().startsWith('<!DOCTYPE') || 
                                   code.trim().startsWith('<html') || 
                                   code.includes('<html') ||
                                   code.includes('<!DOCTYPE');
            
            const canvasId = `canvas-${level.id}`;
            const iframeId = `iframe-${level.id}`;
            
            // å¦‚æœæ˜¯HTMLæ–‡æ¡£ï¼Œä½¿ç”¨iframeåŠ è½½
            if (isHTMLDocument) {
                console.log('æ£€æµ‹åˆ°HTMLæ–‡æ¡£ï¼Œä½¿ç”¨iframeåŠ è½½');
                // åˆ›å»ºBlob URLæ¥åŠ è½½HTMLå†…å®¹
                const blob = new Blob([code], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                
                return {
                    html: `
                        <div class="level-container active">
                            <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${level.title || 'Canvaså…³å¡'}</h2>
                            <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${level.description || ''}</p>
                            
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; color: #1565c0; font-size: 14px;">
                                <p style="margin: 0 0 10px 0; font-weight: bold;">ğŸ“· æ‘„åƒå¤´æƒé™æç¤º</p>
                                <p style="margin: 0; font-size: 13px;">æ­¤ARåº”ç”¨éœ€è¦è®¿é—®æ‚¨çš„æ‘„åƒå¤´ã€‚å½“æµè§ˆå™¨æç¤ºæ—¶ï¼Œè¯·ç‚¹å‡»"å…è®¸"ã€‚</p>
                            </div>
                            
                            <div class="canvas-container" style="padding: 0; background: #000;">
                                <div class="canvas-wrapper" style="padding: 0;">
                                    <iframe 
                                        id="${iframeId}" 
                                        src="${blobUrl}"
                                        style="width: 100%; height: 600px; border: none; border-radius: 8px; display: block; margin: 0 auto;"
                                        allow="camera; microphone; autoplay"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            </div>
                            
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; color: #856404; font-size: 13px;">
                                <p style="margin: 0 0 8px 0; font-weight: bold;">ğŸ’¡ å¦‚æœæ‘„åƒå¤´æ— æ³•å¯åŠ¨ï¼Œè¯·å°è¯•ï¼š</p>
                                <ol style="margin: 0; padding-left: 20px; text-align: left;">
                                    <li>æ£€æŸ¥æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å›¾æ ‡æˆ–æ‘„åƒå¤´å›¾æ ‡</li>
                                    <li>ç‚¹å‡»å›¾æ ‡ï¼Œé€‰æ‹©"å…è®¸"æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™</li>
                                    <li>å¦‚æœå·²ç»æ‹’ç»è¿‡ï¼Œè¯·åˆ·æ–°é¡µé¢å¹¶é‡æ–°æˆæƒ</li>
                                    <li>ç¡®ä¿æ²¡æœ‰å…¶ä»–åº”ç”¨æ­£åœ¨ä½¿ç”¨æ‘„åƒå¤´</li>
                                </ol>
                            </div>
                        </div>
                    `,
                    code: null, // HTMLæ–‡æ¡£ä¸éœ€è¦æ‰§è¡Œä»£ç 
                    blobUrl: blobUrl // ä¿å­˜blob URLä»¥ä¾¿åç»­æ¸…ç†
                };
            }
            
            // å¦‚æœæ˜¯çº¯JavaScriptä»£ç ï¼Œä½¿ç”¨canvas
            return {
                html: `
                    <div class="level-container active">
                        <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${level.title || 'Canvaså…³å¡'}</h2>
                        <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${level.description || ''}</p>
                        
                        <div class="canvas-container">
                            <div class="canvas-wrapper">
                                <canvas id="${canvasId}" width="800" height="600" style="width: 100%; max-width: 800px; height: auto; border: 1px solid #ddd; border-radius: 8px; display: block; margin: 0 auto;"></canvas>
                            </div>
                        </div>
                    </div>
                `,
                code: code
            };
        }

        // å›¾ç‰‡åˆ‡æ¢åŠŸèƒ½
        function initImageGallery(level) {
            currentImageIndex = 0;
            const images = level.images || [];
            const texts = level.texts || [];
            
            window.goToImage = (index) => {
                currentImageIndex = index;
                document.querySelectorAll('.gallery-image').forEach((img, i) => {
                    img.classList.toggle('active', i === index);
                });
                document.querySelectorAll('.gallery-indicator').forEach((ind, i) => {
                    ind.classList.toggle('active', i === index);
                });
                const textEl = document.getElementById('imageText');
                if (textEl) {
                    textEl.textContent = texts[index] || '';
                }
            };
            
            window.previousImage = () => {
                if (currentImageIndex > 0) {
                    goToImage(currentImageIndex - 1);
                }
            };
            
            window.nextImage = () => {
                if (currentImageIndex < images.length - 1) {
                    goToImage(currentImageIndex + 1);
                }
            };
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `<div class="error">
                <h3 style="margin-bottom: 10px;">âš ï¸ é”™è¯¯</h3>
                <p>${message}</p>
                <p style="margin-top: 15px; font-size: 14px; color: #666;">
                    è¯·ç¡®ä¿ï¼š<br>
                    1. åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆcd backend && npm startï¼‰<br>
                    2. æœåŠ¡è¿è¡Œåœ¨ http://localhost:3000<br>
                    3. å·²åœ¨ç®¡ç†ç«¯åˆ›å»ºäº†è¯¾ç¨‹å’Œå…³å¡
                </p>
            </div>`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
