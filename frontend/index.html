<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI学习课程</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'SimHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }


        /* 步骤指示器 */
        .steps-indicator {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            gap: 20px;
            flex-wrap: wrap;
        }

        .step-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: bold;
            font-size: 20px;
        }

        .step-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .step-item.completed {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        /* 内容区域 */
        .content-area {
            padding: 40px;
            min-height: 500px;
        }

        .level-container {
            display: none;
            animation: fadeIn 0.5s;
        }

        .level-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 图片关卡样式 */
        .image-gallery {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 30px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
        }

        .image-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .gallery-image.active {
            display: block;
        }

        .gallery-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
        }

        .gallery-nav-button.prev {
            left: 20px;
        }

        .gallery-nav-button.next {
            right: 20px;
        }

        .gallery-indicators {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .gallery-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
        }

        .gallery-indicator.active {
            background: #667eea;
        }

        /* 视频关卡样式 */
        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            position: relative;
            padding-top: 56.25%;
        }

        .video-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
        }

        /* Canvas关卡样式 */
        .canvas-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 400px;
        }

        .canvas-wrapper {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* 文本说明区域 */
        .text-area {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
        }

        .text-area h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .text-content {
            color: #555;
            font-size: 16px;
            line-height: 1.8;
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 60px 20px;
            color: #c33;
            background: #fee;
            border-radius: 12px;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .content-area {
                padding: 20px;
            }

            .steps-indicator {
                gap: 10px;
            }

            .step-item {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 步骤指示器 -->
        <div class="steps-indicator" id="stepsIndicator">
            <!-- 动态生成 -->
        </div>

        <!-- 内容区域 -->
        <div class="content-area" id="contentArea">
            <div class="loading">加载中...</div>
        </div>
    </div>

    <script>
        // 自动检测环境并设置API地址
        // 如果是本地开发环境（localhost 或 127.0.0.1），使用本地后端
        // 否则使用线上后端（需要部署后端服务）
        // 注意：file:// 协议（直接打开本地文件）也使用线上后端
        const hostname = window.location.hostname;
        const isLocal = (hostname === 'localhost' || hostname === '127.0.0.1') && 
                       window.location.protocol !== 'file:';
        
        // 线上后端地址（部署后端后需要修改这里）
        const PRODUCTION_API_URL = 'https://backend-topaz-zeta-46.vercel.app/api';
        
        const API_BASE_URL = isLocal 
            ? 'http://localhost:3000/api' 
            : PRODUCTION_API_URL;
        
        console.log('当前环境:', isLocal ? '本地开发' : '线上生产');
        console.log('API地址:', API_BASE_URL);
        
        let currentCourse = null;
        let currentLevelIndex = 0;
        let currentImageIndex = 0;

        // 初始化
        async function init() {
            // 清除"加载中"提示
            const contentArea = document.getElementById('contentArea');
            if (contentArea && contentArea.innerHTML.includes('加载中')) {
                contentArea.innerHTML = '';
            }
            
            try {
                // 获取课程列表（这里简化处理，使用第一个课程）
                const coursesRes = await fetch(`${API_BASE_URL}/courses`);
                const coursesData = await coursesRes.json();
                
                if (coursesData.success) {
                    if (coursesData.data.length > 0) {
                        currentCourse = coursesData.data[0];
                        loadCourse(currentCourse);
                    } else {
                        // 数据为空，提示初始化
                        let msg = '暂无课程数据';
                        if (!isLocal) {
                            msg += '<br><br>请使用"初始化数据工具.html"初始化数据到 Vercel 后端';
                        } else {
                            msg += '<br><br>请在管理端创建课程和关卡';
                        }
                        showError(msg);
                    }
                } else {
                    showError('获取课程失败：' + (coursesData.message || '未知错误'));
                }
            } catch (error) {
                console.error('加载失败:', error);
                console.error('API地址:', API_BASE_URL);
                console.error('错误详情:', error.message);
                
                // 更详细的错误提示
                let errorMsg = '加载课程失败';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg += '：无法连接到后端服务';
                    if (!isLocal) {
                        errorMsg += '<br><br>线上环境提示：<br>1. 请确保已使用"初始化数据工具.html"初始化数据<br>2. 后端地址：' + PRODUCTION_API_URL;
                    } else {
                        errorMsg += '<br><br>本地环境提示：<br>1. 请确保后端服务已启动（cd backend && npm start）<br>2. 服务应运行在 http://localhost:3000';
                    }
                } else {
                    errorMsg += '：' + error.message;
                }
                showError(errorMsg);
            }
        }

        // 加载课程
        async function loadCourse(course) {
            if (!course || !course.levelIds || course.levelIds.length === 0) {
                showError('课程中没有关卡');
                return;
            }

            // 生成步骤指示器
            generateStepsIndicator(course.levelIds.length);

            // 加载第一个关卡
            await loadLevel(0);
        }

        // 生成步骤指示器
        function generateStepsIndicator(count) {
            const indicator = document.getElementById('stepsIndicator');
            indicator.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const step = document.createElement('div');
                step.className = 'step-item' + (i === 0 ? ' active' : '');
                step.textContent = i + 1;
                step.onclick = () => goToLevel(i);
                indicator.appendChild(step);
            }
        }

        // 跳转到指定关卡
        async function goToLevel(index) {
            if (!currentCourse || index < 0 || index >= currentCourse.levelIds.length) {
                return;
            }

            currentLevelIndex = index;
            await loadLevel(index);
            
            // 更新步骤指示器
            document.querySelectorAll('.step-item').forEach((item, i) => {
                item.classList.remove('active', 'completed');
                if (i < index) {
                    item.classList.add('completed');
                } else if (i === index) {
                    item.classList.add('active');
                }
            });
        }

        // 加载关卡
        async function loadLevel(index) {
            const levelId = currentCourse.levelIds[index];
            
            try {
                const levelRes = await fetch(`${API_BASE_URL}/levels/${levelId}`);
                const levelData = await levelRes.json();
                
                if (levelData.success) {
                    renderLevel(levelData.data);
                } else {
                    showError('加载关卡失败');
                }
            } catch (error) {
                console.error('加载关卡失败:', error);
                showError('加载关卡失败');
            }
        }

        // 渲染关卡
        async function renderLevel(level) {
            const contentArea = document.getElementById('contentArea');
            
            let html = '';
            let canvasCode = null;
            let blobUrl = null;
            
            if (level.type === 'image') {
                html = renderImageLevel(level);
            } else if (level.type === 'video') {
                html = renderVideoLevel(level);
            } else if (level.type === 'canvas') {
                const result = await renderCanvasLevel(level);
                html = result.html;
                canvasCode = result.code;
                blobUrl = result.blobUrl; // 保存blob URL以便后续清理
            } else if (level.type === 'quiz') {
                html = renderQuizLevel(level);
            }
            
            contentArea.innerHTML = html;
            
            // 如果是Canvas关卡且是HTML文档（使用iframe），不需要执行代码
            if (level.type === 'canvas' && blobUrl) {
                // HTML文档已经在iframe中加载，不需要额外处理
                console.log('HTML文档已在iframe中加载');
                return;
            }
            
            // 如果是Canvas关卡，执行代码
            if (level.type === 'canvas' && canvasCode) {
                const canvasId = `canvas-${level.id}`;
                // 使用更可靠的方式等待canvas元素准备好
                const executeCanvasCode = () => {
                    const canvas = document.getElementById(canvasId);
                    if (canvas) {
                        try {
                            const ctx = canvas.getContext('2d');
                            
                            // 清理代码：移除可能的BOM标记和多余的空白
                            let cleanCode = canvasCode.trim();
                            
                            // 输出调试信息
                            console.log('准备执行Canvas代码，代码长度:', cleanCode.length);
                            console.log('代码前100字符:', cleanCode.substring(0, 100));
                            
                            // 使用字符串拼接而不是模板字符串，避免代码中的特殊字符导致语法错误
                            // 将代码作为Function构造函数的最后一个参数（函数体）
                            // 使用数组拼接来构建函数体字符串，避免模板字符串的问题
                            const functionBodyParts = [
                                'try {',
                                cleanCode,
                                '} catch (e) {',
                                '    console.error(\'代码内部错误:\', e);',
                                '    throw e;',
                                '}'
                            ];
                            
                            // 创建函数，canvas和ctx作为参数
                            const scopeFunction = new Function('canvas', 'ctx', functionBodyParts.join('\n'));
                            
                            // 执行代码
                            scopeFunction(canvas, ctx);
                            
                            console.log('Canvas代码执行成功');
                        } catch (error) {
                            console.error('Canvas代码执行错误:', error);
                            console.error('错误名称:', error.name);
                            console.error('错误消息:', error.message);
                            console.error('错误堆栈:', error.stack);
                            console.error('代码前200字符:', canvasCode.substring(0, 200));
                            console.error('完整代码:', canvasCode);
                            
                            // 尝试显示更详细的错误信息
                            try {
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = '#f0f0f0';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                ctx.fillStyle = '#c33';
                                ctx.font = '14px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // 显示错误信息
                                const errorMsg = error.name + ': ' + error.message;
                                const errorLines = errorMsg.match(/.{1,50}/g) || [errorMsg];
                                
                                // 如果错误信息太长，只显示前几行
                                const maxLines = 5;
                                const displayLines = errorLines.slice(0, maxLines);
                                
                                displayLines.forEach((line, i) => {
                                    ctx.fillText(line, canvas.width / 2, canvas.height / 2 - (displayLines.length - 1) * 12 + i * 24);
                                });
                                
                                if (errorLines.length > maxLines) {
                                    ctx.fillText('...', canvas.width / 2, canvas.height / 2 + (maxLines - 1) * 12 + 24);
                                }
                                
                                // 显示提示信息
                                ctx.fillStyle = '#666';
                                ctx.font = '12px Arial';
                                ctx.fillText('请查看浏览器控制台获取详细信息', canvas.width / 2, canvas.height / 2 + (maxLines + 1) * 12 + 24);
                            } catch (renderError) {
                                console.error('渲染错误信息失败:', renderError);
                            }
                        }
                    } else {
                        // 如果canvas还没准备好，再等一会儿
                        setTimeout(executeCanvasCode, 50);
                    }
                };
                
                // 延迟执行，确保DOM已更新
                setTimeout(executeCanvasCode, 200);
            }
            
            // 如果是图片关卡，初始化图片切换功能
            if (level.type === 'image' && level.images && level.images.length > 0) {
                initImageGallery(level);
            }
        }

        // 渲染选择题关卡
        function renderQuizLevel(level) {
            const quiz = level.quiz || { questions: [] };
            const questions = quiz.questions || [];

            if (!questions.length) {
                return `
                    <div class="level-container active">
                        <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${level.title || '选择题关卡'}</h2>
                        <div class="error">此选择题关卡没有题目</div>
                    </div>
                `;
            }

            const qHtml = questions.map((q, qi) => {
                const type = q.type || 'single';
                const inputType = type === 'multi' ? 'checkbox' : 'radio';
                const options = q.options || [];
                const optsHtml = options.map((o, oi) => {
                    const id = `q${qi}_o${oi}`;
                    return `
                        <label for="${id}" style="display:flex; gap:10px; align-items:flex-start; padding:10px; border:1px solid #e5e7eb; border-radius:10px; margin:10px 0; cursor:pointer; background:#fff;">
                            <input id="${id}" name="q${qi}" type="${inputType}" value="${oi}" style="margin-top:3px;">
                            <span>${escapeHtml(o.text || '')}</span>
                        </label>
                    `;
                }).join('');

                return `
                    <div class="quiz-question" data-qi="${qi}" style="background:#f8f9fa; border-radius:12px; padding:16px; margin:16px 0;">
                        <div style="font-weight:700; margin-bottom:10px;">${qi + 1}. ${escapeHtml(q.prompt || '')}</div>
                        <div class="quiz-options">${optsHtml}</div>
                        <div class="quiz-feedback" style="display:none; margin-top:12px; padding:10px; border-radius:10px;"></div>
                    </div>
                `;
            }).join('');

            // 把题库临时挂到window，供提交按钮判题
            window.__currentQuiz = { levelId: level.id, quiz };

            return `
                <div class="level-container active">
                    <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${escapeHtml(level.title || '选择题关卡')}</h2>
                    <p class="section-description" style="text-align: center; color: #666; margin-bottom: 20px;">${escapeHtml(level.description || '')}</p>

                    <div style="max-width: 900px; margin: 0 auto;">
                        ${qHtml}
                        <div style="text-align:center; margin-top: 20px;">
                            <button onclick="submitQuiz()" style="background:#667eea; color:#fff; border:none; padding:12px 18px; border-radius:12px; cursor:pointer; font-weight:700;">
                                提交答案
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // 转义模板字符串中的特殊字符，防止代码片段显示在页面上
        function escapeForTemplate(str) {
            if (!str) return '';
            return String(str)
                .replace(/\\/g, '\\\\')
                .replace(/`/g, '\\`')
                .replace(/\${/g, '\\${');
        }

        // 提交并判题
        window.submitQuiz = function() {
            const payload = window.__currentQuiz;
            if (!payload || !payload.quiz) return;
            const questions = payload.quiz.questions || [];

            questions.forEach((q, qi) => {
                const type = q.type || 'single';
                const options = q.options || [];
                const correct = options.map((o, oi) => (o && o.correct === true ? oi : null)).filter(v => v !== null);

                const selected = Array.from(document.querySelectorAll(`input[name="q${qi}"]:checked`)).map(el => Number(el.value));

                const isCorrect = (type === 'multi')
                    ? (selected.length === correct.length && selected.every(v => correct.includes(v)))
                    : (selected.length === 1 && correct.includes(selected[0]));

                const wrap = document.querySelector(`.quiz-question[data-qi="${qi}"] .quiz-feedback`);
                if (!wrap) return;
                wrap.style.display = 'block';
                wrap.style.border = isCorrect ? '1px solid #86efac' : '1px solid #fca5a5';
                wrap.style.background = isCorrect ? '#dcfce7' : '#fee2e2';
                const exp = q.explanation ? `<div style="margin-top:8px; color:#374151;"><strong>解析：</strong>${escapeHtml(q.explanation)}</div>` : '';
                const correctLabels = correct.map(idx => options[idx] ? options[idx].text : '').filter(Boolean).map(escapeHtml).join('、');
                const selectedRationales = selected
                    .map(idx => options[idx] && options[idx].rationale ? options[idx].rationale : '')
                    .filter(Boolean)
                    .map(r => `<div style="margin-top:6px; color:#374151;"><strong>你选的理由：</strong>${escapeHtml(r)}</div>`)
                    .join('');
                const hint = q.hint ? `<div style="margin-top:8px; color:#6b7280;"><strong>提示：</strong>${escapeHtml(q.hint)}</div>` : '';
                wrap.innerHTML = `
                    <div style="font-weight:700; color:${isCorrect ? '#166534' : '#991b1b'};">
                        ${isCorrect ? '正确' : '不正确'}（正确答案：${correctLabels || '未标注'}）
                    </div>
                    ${selectedRationales}
                    ${exp}
                    ${hint}
                `;
            });
        };

        // 渲染图片关卡
        function renderImageLevel(level) {
            const images = level.images || [];
            const texts = level.texts || [];
            
            // 构建图片URL：如果是相对路径，需要加上API基础URL
            const getImageUrl = (imgPath) => {
                if (!imgPath) return '';
                // 如果已经是完整URL，直接返回
                if (imgPath.startsWith('http://') || imgPath.startsWith('https://')) {
                    return imgPath;
                }
                // 如果是相对路径，构建完整URL
                // Vercel环境需要通过API提供文件，本地环境可以直接访问
                if (isLocal) {
                    return `http://localhost:3000${imgPath}`;
                } else {
                    // Vercel环境：通过API提供文件
                    // 将 /uploads/images/xxx.png 转换为 /api/uploads/images/xxx.png
                    if (imgPath.startsWith('/uploads/')) {
                        return `${API_BASE_URL}${imgPath}`;
                    }
                    // 如果路径不包含 /uploads/，添加它
                    const cleanPath = imgPath.startsWith('/') ? imgPath : '/' + imgPath;
                    return `${API_BASE_URL}/uploads/images${cleanPath}`;
                }
            };
            
            let imagesHtml = images.map((img, index) => 
                `<img src="${getImageUrl(img)}" alt="图片${index + 1}" class="gallery-image ${index === 0 ? 'active' : ''}" data-index="${index}" onerror="this.style.display='none'; console.error('图片加载失败:', '${img}');">`
            ).join('');
            
            let indicatorsHtml = images.map((_, index) => 
                `<div class="gallery-indicator ${index === 0 ? 'active' : ''}" onclick="goToImage(${index})"></div>`
            ).join('');
            
            return `
                <div class="level-container active">
                    <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${level.title || '图片关卡'}</h2>
                    <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${level.description || ''}</p>
                    
                    <div class="image-gallery">
                        <div class="image-wrapper">
                            ${imagesHtml}
                        </div>
                        ${images.length > 1 ? `
                            <button class="gallery-nav-button prev" onclick="previousImage()">‹</button>
                            <button class="gallery-nav-button next" onclick="nextImage()">›</button>
                        ` : ''}
                    </div>
                    
                    ${images.length > 1 ? `<div class="gallery-indicators">${indicatorsHtml}</div>` : ''}
                    
                    <div class="text-area">
                        <h3>图片说明</h3>
                        <div class="text-content" id="imageText">${texts[0] || ''}</div>
                    </div>
                </div>
            `;
        }

        // 渲染视频关卡
        function renderVideoLevel(level) {
            // 构建视频URL
            const getVideoUrl = (videoPath) => {
                if (!videoPath) return '';
                // 如果已经是完整URL，直接返回
                if (videoPath.startsWith('http://') || videoPath.startsWith('https://')) {
                    return videoPath;
                }
                // 如果是相对路径，构建完整URL
                if (isLocal) {
                    return `http://localhost:3000${videoPath}`;
                } else {
                    // Vercel环境：通过API提供文件
                    // 将 /uploads/videos/xxx.mp4 转换为 /api/uploads/videos/xxx.mp4
                    if (videoPath.startsWith('/uploads/')) {
                        return `${API_BASE_URL}${videoPath}`;
                    }
                    // 如果路径不包含 /uploads/，添加它
                    const cleanPath = videoPath.startsWith('/') ? videoPath : '/' + videoPath;
                    return `${API_BASE_URL}/uploads/videos${cleanPath}`;
                }
            };
            
            const videoUrl = getVideoUrl(level.videoUrl);
            
            return `
                <div class="level-container active">
                    <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${escapeHtml(level.title || '视频关卡')}</h2>
                    <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${level.description || ''}</p>
                    
                    <div class="video-container">
                        <div class="video-wrapper">
                            <video controls>
                                <source src="${videoUrl}" type="video/mp4">
                                您的浏览器不支持视频播放
                            </video>
                        </div>
                    </div>
                </div>
            `;
        }

        // 渲染Canvas关卡
        async function renderCanvasLevel(level) {
            // 方式0：已部署应用URL（React/Vite build等），优先 iframe 打开
            if (level.appUrl && String(level.appUrl).trim()) {
                const appUrl = String(level.appUrl).trim();
                const iframeId = `iframe-${level.id}`;
                return {
                    html: `
                        <div class="level-container active">
                            <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${escapeHtml(level.title || 'Canvas关卡')}</h2>
                            <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${escapeHtml(level.description || '')}</p>

                            <div class="canvas-container" style="padding: 0; background: #000;">
                                <div class="canvas-wrapper" style="padding: 0;">
                                    <iframe
                                        id="${iframeId}"
                                        src="${appUrl}"
                                        style="width: 100%; height: 650px; border: none; border-radius: 8px; display: block; margin: 0 auto;"
                                        allow="camera; microphone; autoplay"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            </div>
                        </div>
                    `,
                    code: null
                };
            }

            let code = level.code || '';
            
            // 如果有代码URL，优先加载代码文件
            if (level.codeUrl) {
                try {
                    // 构建代码文件URL
                    let codeUrl = level.codeUrl;
                    if (codeUrl.startsWith('http://') || codeUrl.startsWith('https://')) {
                        // 已经是完整URL，直接使用
                    } else if (codeUrl.startsWith('/uploads/')) {
                        // Vercel环境：通过API提供文件
                        codeUrl = `${API_BASE_URL}${codeUrl}`;
                    } else {
                        // 相对路径
                        if (isLocal) {
                            codeUrl = `http://localhost:3000${codeUrl.startsWith('/') ? codeUrl : '/' + codeUrl}`;
                        } else {
                            // Vercel环境：假设是 /uploads/canvas/xxx.js 格式
                            const cleanPath = codeUrl.startsWith('/') ? codeUrl : '/' + codeUrl;
                            codeUrl = `${API_BASE_URL}/uploads/canvas${cleanPath}`;
                        }
                    }
                    
                    const codeRes = await fetch(codeUrl);
                    if (codeRes.ok) {
                        const loadedCode = await codeRes.text();
                        if (loadedCode && loadedCode.trim()) {
                            code = loadedCode;
                        }
                    } else {
                        console.warn('加载代码文件失败，状态码:', codeRes.status, 'URL:', codeUrl);
                    }
                } catch (error) {
                    console.error('加载代码失败:', error, 'URL:', level.codeUrl);
                    // 如果加载失败，尝试使用level.code
                    if (!code && level.code) {
                        code = level.code;
                    }
                }
            }
            
            // 如果还是没有代码，显示错误
            if (!code || !code.trim()) {
                console.error('Canvas关卡没有代码内容');
                return {
                    html: `
                        <div class="level-container active">
                            <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${escapeHtml(level.title || 'Canvas关卡')}</h2>
                            <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${escapeHtml(level.description || '')}</p>
                            <div class="error" style="text-align: center; padding: 40px;">
                                <p>⚠️ Canvas关卡代码未找到或为空</p>
                                <p style="margin-top: 10px; font-size: 14px; color: #666;">请检查关卡配置或重新上传代码</p>
                            </div>
                        </div>
                    `,
                    code: null
                };
            }
            
            // 检测代码是否是完整的HTML文档
            const isHTMLDocument = code.trim().startsWith('<!DOCTYPE') || 
                                   code.trim().startsWith('<html') || 
                                   code.includes('<html') ||
                                   code.includes('<!DOCTYPE');
            
            // 检测是否是React代码（包含import或JSX语法）
            // 暂时禁用React实时渲染功能
            const isReactCode = false; // 暂时禁用
            // const isReactCode = code.includes('import ') || 
            //                    code.includes('from ') ||
            //                    (code.includes('<') && code.includes('/>')) ||
            //                    code.includes('React.createElement') ||
            //                    code.includes('useState') ||
            //                    code.includes('useEffect');
            
            const canvasId = `canvas-${level.id}`;
            const iframeId = `iframe-${level.id}`;
            
            // React实时渲染功能已暂时禁用
            // 如果需要启用，请取消下面的注释并移除 if (false) 条件
            
            // 如果是HTML文档，使用iframe加载
            if (isHTMLDocument) {
                console.log('检测到HTML文档，使用iframe加载');
                const blob = new Blob([code], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                return {
                    html: `
                        <div class="level-container active">
                            <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${escapeHtml(level.title || 'Canvas关卡')}</h2>
                            <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${escapeHtml(level.description || '')}</p>
                            
                            <div class="canvas-container" style="padding: 0; background: #000;">
                                <div class="canvas-wrapper" style="padding: 0;">
                                    <iframe 
                                        id="${iframeId}" 
                                        src="${blobUrl}" 
                                        style="width: 100%; height: 650px; border: none; border-radius: 8px; display: block; margin: 0 auto;"
                                        allow="camera; microphone; autoplay"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            </div>
                        </div>
                    `,
                    code: null,
                    blobUrl: blobUrl
                };
            }
            
            return {
                html: `
                    <div class="level-container active">
                        <h2 class="section-title" style="text-align: center; margin-bottom: 20px; color: #333;">${escapeHtml(level.title || 'Canvas关卡')}</h2>
                        <p class="section-description" style="text-align: center; color: #666; margin-bottom: 30px;">${escapeHtml(level.description || '')}</p>
                        
                        <div class="canvas-container">
                            <div class="canvas-wrapper">
                                <canvas id="${canvasId}" width="800" height="600" style="width: 100%; max-width: 800px; height: auto; border: 1px solid #ddd; border-radius: 8px; display: block; margin: 0 auto;"></canvas>
                            </div>
                        </div>
                    </div>
                `,
                code: code
            };
        }

        // 图片切换功能
        function initImageGallery(level) {
            currentImageIndex = 0;
            const images = level.images || [];
            const texts = level.texts || [];
            
            window.goToImage = (index) => {
                currentImageIndex = index;
                document.querySelectorAll('.gallery-image').forEach((img, i) => {
                    img.classList.toggle('active', i === index);
                });
                document.querySelectorAll('.gallery-indicator').forEach((ind, i) => {
                    ind.classList.toggle('active', i === index);
                });
                const textEl = document.getElementById('imageText');
                if (textEl) {
                    textEl.textContent = texts[index] || '';
                }
            };
            
            window.previousImage = () => {
                if (currentImageIndex > 0) {
                    goToImage(currentImageIndex - 1);
                }
            };
            
            window.nextImage = () => {
                if (currentImageIndex < images.length - 1) {
                    goToImage(currentImageIndex + 1);
                }
            };
        }

        // 显示错误
        function showError(message) {
            const contentArea = document.getElementById('contentArea');
            const hostname = window.location.hostname;
            const isLocalEnv = (hostname === 'localhost' || hostname === '127.0.0.1') && 
                              window.location.protocol !== 'file:';
            
            let errorTips = '';
            if (isLocalEnv) {
                errorTips = `
                    请确保：<br>
                    1. 后端服务已启动（cd backend && npm start）<br>
                    2. 服务运行在 http://localhost:3000<br>
                    3. 已在管理端创建了课程和关卡
                `;
            } else {
                errorTips = `
                    <strong>线上环境提示：</strong><br>
                    1. 后端服务尚未部署或配置<br>
                    2. 请部署后端服务到云平台（如 Vercel、Railway）<br>
                    3. 部署后，修改前端代码中的 PRODUCTION_API_URL 为实际后端地址<br>
                    4. 当前配置的后端地址：${API_BASE_URL}
                `;
            }
            
            // 使用 createElement 而不是 innerHTML，避免模板字符串问题
            contentArea.innerHTML = '';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <h3 style="margin-bottom: 10px;">⚠️ 错误</h3>
                <p>${escapeHtml(message)}</p>
                <p style="margin-top: 15px; font-size: 14px; color: #666;">
                    ${errorTips}
                </p>
            `;
            contentArea.appendChild(errorDiv);
        }

        // 页面加载时初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>
