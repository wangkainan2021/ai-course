<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹ç®¡ç† - AIå­¦ä¹ è¯¾ç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'SimHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-upload input {
            display: none;
        }

        .file-list {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .image-item {
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            border: 2px solid #e0e0e0;
        }

        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .image-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-item .delete-btn:hover {
            background: #c82333;
        }

        .image-item .text-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 5px;
        }

        .image-item .file-name {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            word-break: break-all;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .level-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .level-list-container {
            margin-top: 20px;
        }

        .level-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .level-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .level-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .level-card-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 20px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .level-card-title {
            flex: 1;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }

        .level-card-actions {
            display: flex;
            gap: 10px;
        }

        .btn-edit {
            background: #28a745;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-edit:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .level-card-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .level-info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .level-info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .level-info-item .value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* ç¼–è¾‘æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            color: #333;
            margin: 0;
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            line-height: 35px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: #333;
            background: #f0f0f0;
        }

        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .badge-image {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-video {
            background: #fce4ec;
            color: #c2185b;
        }

        .badge-canvas {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .course-list {
            margin-top: 20px;
        }

        .course-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }

        .course-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .checkbox-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
        }

        .checkbox-item input {
            width: auto;
            margin-right: 10px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š è¯¾ç¨‹ç®¡ç†ç³»ç»Ÿ</h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">ä¸Šä¼ å…³å¡</button>
            <button class="tab" onclick="switchTab('course')">åˆ›å»ºè¯¾ç¨‹</button>
            <button class="tab" onclick="switchTab('manage')">ç®¡ç†è¯¾ç¨‹</button>
            <button class="tab" onclick="switchTab('levels')">ç®¡ç†å…³å¡</button>
        </div>

        <!-- ä¸Šä¼ å…³å¡ -->
        <div id="uploadTab" class="tab-content active">
            <h2>ä¸Šä¼ å…³å¡</h2>
            
            <div class="message" id="uploadMessage"></div>

            <div class="tabs" style="margin-top: 20px;">
                <button class="tab active" onclick="switchLevelType('image')">å›¾ç‰‡å…³å¡</button>
                <button class="tab" onclick="switchLevelType('video')">è§†é¢‘å…³å¡</button>
                <button class="tab" onclick="switchLevelType('canvas')">Canvaså…³å¡</button>
                <button class="tab" onclick="switchLevelType('quiz')">é€‰æ‹©é¢˜å…³å¡</button>
            </div>

            <!-- å›¾ç‰‡å…³å¡è¡¨å• -->
            <form id="imageForm" class="level-form">
                <div class="form-group">
                    <label>å…³å¡æ ‡é¢˜</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>å…³å¡æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡ï¼ˆä¸€å¼ ä¸€å¼ ä¸Šä¼ ï¼‰</label>
                    <div class="file-upload" onclick="document.getElementById('imageFile').click()">
                        <p>ğŸ“· ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</p>
                        <input type="file" id="imageFile" name="image" accept="image/*" onchange="handleSingleImage(this.files)">
                    </div>
                    <div class="file-list" id="imageFileList"></div>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ å›¾ç‰‡å…³å¡</button>
            </form>

            <!-- è§†é¢‘å…³å¡è¡¨å• -->
            <form id="videoForm" class="level-form" style="display: none;">
                <div class="form-group">
                    <label>å…³å¡æ ‡é¢˜</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>å…³å¡æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ è§†é¢‘</label>
                    <div class="file-upload" onclick="document.getElementById('videoFile').click()">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°è¿™é‡Œ</p>
                        <input type="file" id="videoFile" name="video" accept="video/*" onchange="handleVideoFile(this.files)">
                    </div>
                    <div class="file-list" id="videoFileList"></div>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ è§†é¢‘å…³å¡</button>
            </form>

            <!-- Canvaså…³å¡è¡¨å• -->
            <form id="canvasForm" class="level-form" style="display: none;">
                <div class="form-group">
                    <label>å…³å¡æ ‡é¢˜</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>å…³å¡æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>React/å‰ç«¯åº”ç”¨ URLï¼ˆå·²éƒ¨ç½²ï¼Œæ¨èï¼‰</label>
                    <input type="url" name="appUrl" placeholder="ä¾‹å¦‚ï¼šhttps://wangkainan2021.github.io/ai-course/apps/my-ar-app/">
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">å½“ä½ çš„ä»£ç åŒ…å« import React / npm åŒ…æ—¶ï¼Œè¯·å…ˆç”¨ Vite æ‰“åŒ…å¹¶éƒ¨ç½²ï¼Œç„¶ååœ¨è¿™é‡Œå¡« URLã€‚å­¦ç”Ÿç«¯ä¼šç”¨ iframe æ‰“å¼€ã€‚</p>
                </div>
                <div class="form-group">
                    <label>Canvasä»£ç </label>
                    <textarea name="code" rows="15" placeholder="// åœ¨è¿™é‡Œè¾“å…¥Canvasä»£ç &#10;// ä¾‹å¦‚ï¼š&#10;const canvas = document.getElementById('canvas');&#10;const ctx = canvas.getContext('2d');&#10;// ..."></textarea>
                </div>
                <div class="form-group">
                    <label>æˆ–ä¸Šä¼ ä»£ç æ–‡ä»¶</label>
                    <div class="file-upload" onclick="document.getElementById('canvasFile').click()">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä»£ç æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                        <input type="file" id="canvasFile" name="canvas" accept=".js,.html" onchange="handleCanvasFile(this.files)">
                    </div>
                    <div class="file-list" id="canvasFileList"></div>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ Canvaså…³å¡</button>
            </form>

            <!-- é€‰æ‹©é¢˜å…³å¡è¡¨å• -->
            <form id="quizForm" class="level-form" style="display: none;">
                <div class="form-group">
                    <label>å…³å¡æ ‡é¢˜</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>å…³å¡æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©é¢˜JSONï¼ˆæ¨èç›´æ¥ç²˜è´´ï¼‰</label>
                    <textarea name="quizJson" rows="12" style="font-family: monospace;" placeholder='{\n  "questions": [\n    {\n      "prompt": "1+1=ï¼Ÿ",\n      "type": "single",\n      "options": [\n        { "text": "1", "correct": false },\n        { "text": "2", "correct": true }\n      ],\n      "explanation": "1+1=2"\n    }\n  ]\n}'></textarea>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">type: single(å•é€‰) / multi(å¤šé€‰)ã€‚optionsé‡Œç”¨ correct æ ‡è®°æ­£ç¡®é€‰é¡¹ã€‚</p>
                </div>
                <div class="form-group">
                    <label>æˆ–ä¸Šä¼  .json æ–‡ä»¶</label>
                    <div class="file-upload" onclick="document.getElementById('quizFile').click()">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ JSON æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                        <input type="file" id="quizFile" name="quiz" accept=".json,application/json" onchange="handleQuizFile(this.files)">
                    </div>
                    <div class="file-list" id="quizFileList"></div>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ é€‰æ‹©é¢˜å…³å¡</button>
            </form>
        </div>

        <!-- åˆ›å»ºè¯¾ç¨‹ -->
        <div id="courseTab" class="tab-content">
            <h2>åˆ›å»ºè¯¾ç¨‹</h2>
            
            <div class="message" id="courseMessage"></div>

            <form id="courseForm">
                <div class="form-group">
                    <label>è¯¾ç¨‹åç§°</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>è¯¾ç¨‹æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©å…³å¡ï¼ˆæŒ‰ä½Ctrlå¯å¤šé€‰ï¼‰</label>
                    <div class="checkbox-list" id="levelCheckboxes">
                        <div class="loading">åŠ è½½å…³å¡ä¸­...</div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">åˆ›å»ºè¯¾ç¨‹</button>
            </form>
        </div>

        <!-- ç®¡ç†è¯¾ç¨‹ -->
        <div id="manageTab" class="tab-content">
            <h2>ç®¡ç†è¯¾ç¨‹</h2>
            <div id="courseList" class="course-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç¼–è¾‘è¯¾ç¨‹æ¨¡æ€æ¡† -->
        <div id="editCourseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¼–è¾‘è¯¾ç¨‹</h3>
                    <button class="close-modal" onclick="closeEditCourseModal()">&times;</button>
                </div>
                <form id="editCourseForm">
                    <input type="hidden" id="editCourseId">
                    <div class="form-group">
                        <label>è¯¾ç¨‹åç§°</label>
                        <input type="text" id="editCourseName" required>
                    </div>
                    <div class="form-group">
                        <label>è¯¾ç¨‹æè¿°</label>
                        <textarea id="editCourseDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©å…³å¡å¹¶è°ƒæ•´é¡ºåºï¼ˆæ‹–æ‹½å¯è°ƒæ•´é¡ºåºï¼‰</label>
                        <div id="editCourseLevelList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                            <div class="loading">åŠ è½½å…³å¡ä¸­...</div>
                        </div>
                    </div>
                    <div class="button-area" style="margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeEditCourseModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç®¡ç†å…³å¡ -->
        <div id="levelsTab" class="tab-content">
            <h2>ç®¡ç†å…³å¡</h2>
            <div id="levelsList" class="level-list-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç¼–è¾‘å…³å¡æ¨¡æ€æ¡† -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¼–è¾‘å…³å¡</h3>
                    <button class="close-modal" onclick="closeEditModal()">&times;</button>
                </div>
                <form id="editLevelForm">
                    <input type="hidden" id="editLevelId">
                    <div class="form-group">
                        <label>å…³å¡æ ‡é¢˜</label>
                        <input type="text" id="editLevelTitle" required>
                    </div>
                    <div class="form-group">
                        <label>å…³å¡æè¿°</label>
                        <textarea id="editLevelDescription"></textarea>
                    </div>
                    <div id="editLevelContent"></div>
                    <div class="button-area" style="margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒå¹¶è®¾ç½®APIåœ°å€
        // ç¯å¢ƒæ£€æµ‹ï¼šåªæœ‰åœ¨ localhost/127.0.0.1 ä¸”ä¸æ˜¯ file:// åè®®æ—¶æ‰ä½¿ç”¨æœ¬åœ° API
        // file:// åè®®ï¼ˆç›´æ¥æ‰“å¼€æœ¬åœ°æ–‡ä»¶ï¼‰ä½¿ç”¨çº¿ä¸Š API
        const hostname = window.location.hostname;
        const isLocal = (hostname === 'localhost' || hostname === '127.0.0.1') && 
                       window.location.protocol !== 'file:';
        
        // çº¿ä¸Šåç«¯åœ°å€ï¼ˆéƒ¨ç½²åç«¯åéœ€è¦ä¿®æ”¹è¿™é‡Œï¼‰
        const PRODUCTION_API_URL = 'https://backend-topaz-zeta-46.vercel.app/api';
        
        const API_BASE_URL = isLocal 
            ? 'http://localhost:3000/api' 
            : PRODUCTION_API_URL;
        
        console.log('å½“å‰ç¯å¢ƒ:', isLocal ? 'æœ¬åœ°å¼€å‘' : 'çº¿ä¸Šç”Ÿäº§');
        console.log('APIåœ°å€:', API_BASE_URL);
        
        let imageItems = []; // å­˜å‚¨å›¾ç‰‡é¡¹ï¼š{file, preview, text}
        let selectedVideoFile = null;
        let selectedCanvasFile = null;
        let selectedQuizFile = null;

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // æ‰¾åˆ°å¯¹åº”çš„tabæŒ‰é’®å¹¶æ¿€æ´»
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((t) => {
                const onclickAttr = t.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`switchTab('${tab}')`)) {
                    t.classList.add('active');
                }
            });
            
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°åˆ›å»ºè¯¾ç¨‹æ ‡ç­¾ï¼Œåˆ·æ–°å…³å¡åˆ—è¡¨
            if (tab === 'course') {
                loadLevels();
            }
            // å¦‚æœåˆ‡æ¢åˆ°ç®¡ç†å…³å¡æ ‡ç­¾ï¼ŒåŠ è½½å…³å¡åˆ—è¡¨
            if (tab === 'levels') {
                loadLevelsList();
            }
            // å¦‚æœåˆ‡æ¢åˆ°ç®¡ç†è¯¾ç¨‹æ ‡ç­¾ï¼ŒåŠ è½½è¯¾ç¨‹åˆ—è¡¨
            if (tab === 'manage') {
                loadCourses();
            }
        }

        // åˆ‡æ¢å…³å¡ç±»å‹
        function switchLevelType(type) {
            document.querySelectorAll('.level-form').forEach(f => f.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(type + 'Form').style.display = 'block';
        }

        // å¤„ç†å•å¼ å›¾ç‰‡ä¸Šä¼ 
        function handleSingleImage(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            if (!file.type.startsWith('image/')) {
                showMessage('uploadMessage', 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', false);
                return;
            }
            
            // åˆ›å»ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageItem = {
                    id: Date.now(),
                    file: file,
                    preview: e.target.result,
                    text: ''
                };
                
                imageItems.push(imageItem);
                renderImageList();
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                document.getElementById('imageFile').value = '';
            };
            reader.readAsDataURL(file);
        }

        // æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
        function renderImageList() {
            const list = document.getElementById('imageFileList');
            if (imageItems.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = imageItems.map((item, index) => `
                <div class="image-item">
                    <button type="button" class="delete-btn" onclick="removeImageItem(${index})" title="åˆ é™¤">Ã—</button>
                    <img src="${item.preview}" alt="${item.file.name}">
                    <div class="file-name">${item.file.name}</div>
                    <input type="text" 
                           class="text-input" 
                           placeholder="å›¾ç‰‡è¯´æ˜æ–‡å­—" 
                           value="${item.text}"
                           onchange="updateImageText(${index}, this.value)">
                </div>
            `).join('');
        }

        // æ›´æ–°å›¾ç‰‡è¯´æ˜æ–‡å­—
        function updateImageText(index, text) {
            if (imageItems[index]) {
                imageItems[index].text = text;
            }
        }

        // åˆ é™¤å›¾ç‰‡é¡¹
        function removeImageItem(index) {
            imageItems.splice(index, 1);
            renderImageList();
        }

        // å¤„ç†è§†é¢‘æ–‡ä»¶
        function handleVideoFile(files) {
            selectedVideoFile = files[0];
            const list = document.getElementById('videoFileList');
            list.innerHTML = selectedVideoFile ? 
                `<div class="file-item">
                    <span>${selectedVideoFile.name}</span>
                    <button type="button" onclick="removeVideoFile()">åˆ é™¤</button>
                </div>` : '';
        }

        function removeVideoFile() {
            selectedVideoFile = null;
            document.getElementById('videoFile').value = '';
            document.getElementById('videoFileList').innerHTML = '';
        }

        // å¤„ç†Canvasæ–‡ä»¶
        function handleCanvasFile(files) {
            selectedCanvasFile = files[0];
            const list = document.getElementById('canvasFileList');
            list.innerHTML = selectedCanvasFile ? 
                `<div class="file-item">
                    <span>${selectedCanvasFile.name}</span>
                    <button type="button" onclick="removeCanvasFile()">åˆ é™¤</button>
                </div>` : '';
        }

        function removeCanvasFile() {
            selectedCanvasFile = null;
            document.getElementById('canvasFile').value = '';
            document.getElementById('canvasFileList').innerHTML = '';
        }

        // å¤„ç†Quiz JSONæ–‡ä»¶
        function handleQuizFile(files) {
            selectedQuizFile = files[0];
            const list = document.getElementById('quizFileList');
            list.innerHTML = selectedQuizFile ?
                `<div class="file-item">
                    <span>${selectedQuizFile.name}</span>
                    <button type="button" onclick="removeQuizFile()">åˆ é™¤</button>
                </div>` : '';
        }

        function removeQuizFile() {
            selectedQuizFile = null;
            const el = document.getElementById('quizFile');
            if (el) el.value = '';
            const list = document.getElementById('quizFileList');
            if (list) list.innerHTML = '';
        }

        // ä¸Šä¼ å›¾ç‰‡å…³å¡
        document.getElementById('imageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (imageItems.length === 0) {
                showMessage('uploadMessage', 'è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å›¾ç‰‡', false);
                return;
            }
            
            const formData = new FormData();
            formData.append('title', e.target.title.value);
            formData.append('description', e.target.description.value);
            
            // æ·»åŠ æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
            imageItems.forEach(item => {
                formData.append('images', item.file);
            });
            
            // æ·»åŠ è¯´æ˜æ–‡å­—æ•°ç»„
            const texts = imageItems.map(item => item.text || '');
            formData.append('texts', JSON.stringify(texts));

            try {
                console.log('å¼€å§‹ä¸Šä¼ å›¾ç‰‡å…³å¡ï¼Œå›¾ç‰‡æ•°é‡:', imageItems.length);
                console.log('APIåœ°å€:', API_BASE_URL);
                console.log('å½“å‰ç¯å¢ƒ:', isLocal ? 'æœ¬åœ°' : 'çº¿ä¸Š');
                
                const res = await fetch(`${API_BASE_URL}/levels/image`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                console.log('å“åº”URL:', res.url);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status, false);
                    return;
                }
                
                const data = await res.json();
                console.log('å“åº”æ•°æ®:', data);
                
                showMessage('uploadMessage', data.success ? 'ä¸Šä¼ æˆåŠŸï¼' : 'ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), data.success);
                if (data.success) {
                    e.target.reset();
                    imageItems = [];
                    renderImageList();
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                let errorMsg = 'ä¸Šä¼ å¤±è´¥ï¼š' + error.message;
                if (!isLocal) {
                    errorMsg += 'ã€‚è¯·æ£€æŸ¥ï¼š1. åç«¯æœåŠ¡æ˜¯å¦å·²éƒ¨ç½² 2. APIåœ°å€æ˜¯å¦æ­£ç¡®ï¼š' + API_BASE_URL;
                } else {
                    errorMsg += 'ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000';
                }
                showMessage('uploadMessage', errorMsg, false);
            }
        });

        // ä¸Šä¼ è§†é¢‘å…³å¡
        document.getElementById('videoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', e.target.title.value);
            formData.append('description', e.target.description.value);
            
            if (selectedVideoFile) {
                formData.append('video', selectedVideoFile);
            }

            try {
                console.log('å¼€å§‹ä¸Šä¼ è§†é¢‘å…³å¡');
                const res = await fetch(`${API_BASE_URL}/levels/video`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status, false);
                    return;
                }
                
                const data = await res.json();
                console.log('å“åº”æ•°æ®:', data);
                
                showMessage('uploadMessage', data.success ? 'ä¸Šä¼ æˆåŠŸï¼' : 'ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), data.success);
                if (data.success) {
                    e.target.reset();
                    removeVideoFile();
                    // åˆ·æ–°å…³å¡åˆ—è¡¨
                    loadLevels();
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                let errorMsg = 'ä¸Šä¼ å¤±è´¥ï¼š' + error.message;
                if (!isLocal) {
                    errorMsg += 'ã€‚è¯·æ£€æŸ¥ï¼š1. åç«¯æœåŠ¡æ˜¯å¦å·²éƒ¨ç½² 2. APIåœ°å€æ˜¯å¦æ­£ç¡®ï¼š' + API_BASE_URL;
                } else {
                    errorMsg += 'ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000';
                }
                showMessage('uploadMessage', errorMsg, false);
            }
        });

        // ä¸Šä¼ Canvaså…³å¡
        document.getElementById('canvasForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', e.target.title.value);
            formData.append('description', e.target.description.value);
            formData.append('code', e.target.code.value);
            // æ–°å¢ï¼šæ”¯æŒå·²éƒ¨ç½²åº”ç”¨URLï¼ˆReact/Viteï¼‰
            if (e.target.appUrl && e.target.appUrl.value) {
                formData.append('appUrl', e.target.appUrl.value);
            }
            
            if (selectedCanvasFile) {
                formData.append('canvas', selectedCanvasFile);
            }

            try {
                console.log('å¼€å§‹ä¸Šä¼ Canvaså…³å¡');
                const res = await fetch(`${API_BASE_URL}/levels/canvas`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status, false);
                    return;
                }
                
                const data = await res.json();
                console.log('å“åº”æ•°æ®:', data);
                
                showMessage('uploadMessage', data.success ? 'ä¸Šä¼ æˆåŠŸï¼' : 'ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), data.success);
                if (data.success) {
                    e.target.reset();
                    removeCanvasFile();
                    // åˆ·æ–°å…³å¡åˆ—è¡¨
                    loadLevels();
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                let errorMsg = 'ä¸Šä¼ å¤±è´¥ï¼š' + error.message;
                if (!isLocal) {
                    errorMsg += 'ã€‚è¯·æ£€æŸ¥ï¼š1. åç«¯æœåŠ¡æ˜¯å¦å·²éƒ¨ç½² 2. APIåœ°å€æ˜¯å¦æ­£ç¡®ï¼š' + API_BASE_URL;
                } else {
                    errorMsg += 'ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000';
                }
                showMessage('uploadMessage', errorMsg, false);
            }
        });

        // ä¸Šä¼ é€‰æ‹©é¢˜å…³å¡
        document.getElementById('quizForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', e.target.title.value);
            formData.append('description', e.target.description.value);

            const quizJsonText = (e.target.quizJson && e.target.quizJson.value) ? e.target.quizJson.value.trim() : '';

            if (selectedQuizFile) {
                formData.append('quiz', selectedQuizFile);
            } else if (quizJsonText) {
                // ç›´æ¥æäº¤jsonå­—ç¬¦ä¸²ï¼ˆåç«¯ä¼šè§£ææ ¡éªŒï¼‰
                formData.append('quizJson', quizJsonText);
            } else {
                showMessage('uploadMessage', 'è¯·ç²˜è´´é€‰æ‹©é¢˜JSONæˆ–ä¸Šä¼ .jsonæ–‡ä»¶', false);
                return;
            }

            try {
                console.log('å¼€å§‹ä¸Šä¼ é€‰æ‹©é¢˜å…³å¡');
                const res = await fetch(`${API_BASE_URL}/levels/quiz`, {
                    method: 'POST',
                    body: formData
                });

                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                // ç»Ÿä¸€è§£æè¿”å›ï¼ˆå¯èƒ½æ˜¯JSONä¹Ÿå¯èƒ½æ˜¯æ–‡æœ¬ï¼‰
                let data = null;
                const contentType = res.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    data = await res.json();
                } else {
                    const text = await res.text();
                    data = { success: false, message: (text || '').slice(0, 200) };
                }

                if (!res.ok) {
                    console.error('å“åº”é”™è¯¯:', data);
                    showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || ('æœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status)), false);
                    return;
                }

                showMessage('uploadMessage', data.success ? 'é€‰æ‹©é¢˜å…³å¡ä¸Šä¼ æˆåŠŸï¼' : ('ä¸Šä¼ å¤±è´¥ï¼š' + data.message), data.success);
                if (data.success) {
                    e.target.reset();
                    removeQuizFile();
                    loadLevels();
                    loadLevelsList();
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                let errorMsg = 'ä¸Šä¼ å¤±è´¥ï¼š' + error.message;
                if (!isLocal) {
                    errorMsg += 'ã€‚è¯·æ£€æŸ¥ï¼š1. åç«¯æœåŠ¡æ˜¯å¦å·²éƒ¨ç½² 2. APIåœ°å€æ˜¯å¦æ­£ç¡®ï¼š' + API_BASE_URL;
                } else {
                    errorMsg += 'ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000';
                }
                showMessage('uploadMessage', errorMsg, false);
            }
        });

        // åŠ è½½å…³å¡åˆ—è¡¨
        async function loadLevels() {
            const container = document.getElementById('levelCheckboxes');
            if (!container) return;
            
            try {
                console.log('å¼€å§‹åŠ è½½å…³å¡åˆ—è¡¨...');
                container.innerHTML = '<div class="loading">åŠ è½½å…³å¡ä¸­...</div>';
                
                const res = await fetch(`${API_BASE_URL}/levels`);
                console.log('å…³å¡åˆ—è¡¨å“åº”çŠ¶æ€:', res.status);
                
                if (!res.ok) {
                    throw new Error('æœåŠ¡å™¨è¿”å›é”™è¯¯: ' + res.status);
                }
                
                const data = await res.json();
                console.log('å…³å¡åˆ—è¡¨æ•°æ®:', data);
                
                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        renderLevelCheckboxes(data.data);
                    } else {
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— å…³å¡ï¼Œè¯·å…ˆä¸Šä¼ å…³å¡</div>';
                    }
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #c33;">åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å…³å¡å¤±è´¥:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #c33;">åŠ è½½å¤±è´¥: ' + error.message + '<br>è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ</div>';
            }
        }

        // æ¸²æŸ“å…³å¡å¤é€‰æ¡†
        function renderLevelCheckboxes(levels) {
            const container = document.getElementById('levelCheckboxes');
            if (!container) return;
            
            if (levels.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— å…³å¡</div>';
                return;
            }
            
            container.innerHTML = levels.map(level => `
                <div class="checkbox-item">
                    <input type="checkbox" name="levelIds" value="${level.id}" id="level-${level.id}">
                    <label for="level-${level.id}">
                        <strong>${level.title || 'æœªå‘½åå…³å¡'}</strong> 
                        <span class="level-badge badge-${level.type}">${getLevelTypeName(level.type)}</span>
                    </label>
                </div>
            `).join('');
        }

        function getLevelTypeName(type) {
            const names = {
                'image': 'å›¾ç‰‡',
                'video': 'è§†é¢‘',
                'canvas': 'Canvas',
                'quiz': 'é€‰æ‹©é¢˜'
            };
            return names[type] || type;
        }

        // åˆ›å»ºè¯¾ç¨‹
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const levelIds = Array.from(formData.getAll('levelIds'));
            
            const courseData = {
                name: formData.get('name'),
                description: formData.get('description'),
                levelIds: levelIds
            };

            try {
                const res = await fetch(`${API_BASE_URL}/courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });
                const data = await res.json();
                showMessage('courseMessage', data.success ? 'è¯¾ç¨‹åˆ›å»ºæˆåŠŸï¼' : 'åˆ›å»ºå¤±è´¥ï¼š' + data.message, data.success);
                if (data.success) {
                    e.target.reset();
                    loadCourses();
                }
            } catch (error) {
                showMessage('courseMessage', 'åˆ›å»ºå¤±è´¥ï¼š' + error.message, false);
            }
        });

        // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
        async function loadCourses() {
            try {
                const res = await fetch(`${API_BASE_URL}/courses`);
                const data = await res.json();
                if (data.success) {
                    renderCourses(data.data);
                }
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“è¯¾ç¨‹åˆ—è¡¨
        function renderCourses(courses) {
            const container = document.getElementById('courseList');
            if (courses.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— è¯¾ç¨‹</div>';
                return;
            }
            
            container.innerHTML = courses.map((course, index) => `
                <div class="course-item">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                <div style="width: 40px; height: 40px; line-height: 40px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 50%; font-weight: bold;">
                                    ${index + 1}
                                </div>
                                <h3 style="margin: 0;">${course.name}</h3>
                            </div>
                            <p style="color: #666; margin-bottom: 10px;">${course.description || 'æ— æè¿°'}</p>
                            <p style="font-size: 14px; color: #666;">åŒ…å« ${course.levelIds.length} ä¸ªå…³å¡</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-edit" onclick="editCourse('${course.id}')">ç¼–è¾‘</button>
                            <button class="btn-delete" onclick="deleteCourse('${course.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ç¼–è¾‘è¯¾ç¨‹
        async function editCourse(courseId) {
            try {
                // åŠ è½½è¯¾ç¨‹æ•°æ®
                const courseRes = await fetch(`${API_BASE_URL}/courses/${courseId}`);
                const courseData = await courseRes.json();
                
                if (!courseData.success) {
                    alert('åŠ è½½è¯¾ç¨‹å¤±è´¥: ' + courseData.message);
                    return;
                }
                
                const course = courseData.data;
                document.getElementById('editCourseId').value = course.id;
                document.getElementById('editCourseName').value = course.name || '';
                document.getElementById('editCourseDescription').value = course.description || '';
                
                // åŠ è½½å…³å¡åˆ—è¡¨å¹¶é€‰ä¸­å½“å‰è¯¾ç¨‹çš„å…³å¡
                const levelsRes = await fetch(`${API_BASE_URL}/levels`);
                const levelsData = await levelsRes.json();
                
                if (levelsData.success) {
                    renderEditCourseLevelCheckboxes(levelsData.data, course.levelIds || []);
                }
                
                document.getElementById('editCourseModal').classList.add('show');
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
                alert('åŠ è½½è¯¾ç¨‹å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“ç¼–è¾‘è¯¾ç¨‹çš„å…³å¡åˆ—è¡¨ï¼ˆå¯æ‹–æ‹½æ’åºï¼‰
        function renderEditCourseLevelCheckboxes(levels, selectedLevelIds) {
            const container = document.getElementById('editCourseLevelList');
            if (!container) return;
            
            if (levels.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— å…³å¡</div>';
                return;
            }
            
            // åˆ›å»ºå…³å¡æ˜ å°„
            const levelMap = {};
            levels.forEach(level => {
                levelMap[level.id] = level;
            });
            
            // æŒ‰ç…§selectedLevelIdsçš„é¡ºåºæ’åˆ—å·²é€‰ä¸­çš„å…³å¡ï¼Œç„¶åæ·»åŠ æœªé€‰ä¸­çš„
            const orderedLevels = [];
            const selectedLevels = [];
            const unselectedLevels = [];
            
            selectedLevelIds.forEach(id => {
                if (levelMap[id]) {
                    selectedLevels.push(levelMap[id]);
                }
            });
            
            levels.forEach(level => {
                if (!selectedLevelIds.includes(level.id)) {
                    unselectedLevels.push(level);
                }
            });
            
            orderedLevels.push(...selectedLevels, ...unselectedLevels);
            
            container.innerHTML = orderedLevels.map((level, index) => {
                const isChecked = selectedLevelIds.includes(level.id);
                const order = isChecked ? selectedLevelIds.indexOf(level.id) + 1 : '';
                return `
                    <div class="level-sort-item" data-level-id="${level.id}" data-index="${index}" draggable="${isChecked ? 'true' : 'false'}" style="
                        display: flex;
                        align-items: center;
                        padding: 12px;
                        margin-bottom: 8px;
                        background: ${isChecked ? '#f0f7ff' : '#f9f9f9'};
                        border: 2px solid ${isChecked ? '#3b82f6' : '#e0e0e0'};
                        border-radius: 8px;
                        cursor: ${isChecked ? 'move' : 'default'};
                        transition: all 0.2s;
                    ">
                        <div style="display: flex; align-items: center; flex: 1; gap: 12px;">
                            ${isChecked ? `
                                <div class="drag-handle" style="cursor: move; color: #666; font-size: 18px;">â˜°</div>
                                <div style="width: 30px; height: 30px; line-height: 30px; text-align: center; background: #3b82f6; color: white; border-radius: 50%; font-weight: bold; font-size: 14px;">
                                    ${order}
                                </div>
                            ` : ''}
                            <input type="checkbox" name="levelIds" value="${level.id}" id="edit-level-${level.id}" ${isChecked ? 'checked' : ''} 
                                   onchange="updateLevelOrder(this, '${level.id}')" style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="edit-level-${level.id}" style="flex: 1; cursor: pointer; margin: 0;">
                                <strong>${level.title || 'æœªå‘½åå…³å¡'}</strong> 
                                <span class="level-badge badge-${level.type}">${getLevelTypeName(level.type)}</span>
                            </label>
                        </div>
                    </div>
                `;
            }).join('');
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initLevelDragAndDrop();
        }
        
        // åˆå§‹åŒ–å…³å¡æ‹–æ‹½æ’åº
        function initLevelDragAndDrop() {
            const items = document.querySelectorAll('.level-sort-item[draggable="true"]');
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', item.outerHTML);
                    e.dataTransfer.setData('text/plain', item.dataset.levelId);
                    item.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', (e) => {
                    item.style.opacity = '1';
                });
                
                item.addEventListener('dragover', (e) => {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.dataTransfer.dropEffect = 'move';
                    return false;
                });
                
                item.addEventListener('dragenter', (e) => {
                    if (item.dataset.levelId !== e.dataTransfer.getData('text/plain')) {
                        item.style.borderColor = '#3b82f6';
                        item.style.transform = 'scale(1.02)';
                    }
                });
                
                item.addEventListener('dragleave', (e) => {
                    item.style.borderColor = '#3b82f6';
                    item.style.transform = 'scale(1)';
                });
                
                item.addEventListener('drop', (e) => {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    const draggedId = e.dataTransfer.getData('text/plain');
                    const targetId = item.dataset.levelId;
                    
                    if (draggedId !== targetId) {
                        reorderLevels(draggedId, targetId);
                    }
                    
                    item.style.borderColor = '#3b82f6';
                    item.style.transform = 'scale(1)';
                    return false;
                });
            });
        }
        
        // é‡æ–°æ’åºå…³å¡
        function reorderLevels(draggedId, targetId) {
            const formData = new FormData(document.getElementById('editCourseForm'));
            const levelIds = Array.from(formData.getAll('levelIds'));
            
            const draggedIndex = levelIds.indexOf(draggedId);
            const targetIndex = levelIds.indexOf(targetId);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                levelIds.splice(draggedIndex, 1);
                levelIds.splice(targetIndex, 0, draggedId);
                
                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                levelIds.forEach(id => {
                    const checkbox = document.getElementById(`edit-level-${id}`);
                    if (checkbox && !checkbox.checked) {
                        checkbox.checked = true;
                    }
                });
                
                // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                const levelsRes = fetch(`${API_BASE_URL}/levels`).then(res => res.json());
                levelsRes.then(levelsData => {
                    if (levelsData.success) {
                        renderEditCourseLevelCheckboxes(levelsData.data, levelIds);
                    }
                });
            }
        }
        
        // æ›´æ–°å…³å¡é¡ºåºï¼ˆå½“å¤é€‰æ¡†çŠ¶æ€æ”¹å˜æ—¶ï¼‰
        function updateLevelOrder(checkbox, levelId) {
            const formData = new FormData(document.getElementById('editCourseForm'));
            let levelIds = Array.from(formData.getAll('levelIds'));
            
            if (checkbox.checked) {
                if (!levelIds.includes(levelId)) {
                    levelIds.push(levelId);
                }
            } else {
                levelIds = levelIds.filter(id => id !== levelId);
            }
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°é¡ºåºæ˜¾ç¤º
            const levelsRes = fetch(`${API_BASE_URL}/levels`).then(res => res.json());
            levelsRes.then(levelsData => {
                if (levelsData.success) {
                    renderEditCourseLevelCheckboxes(levelsData.data, levelIds);
                }
            });
        }

        // å…³é—­ç¼–è¾‘è¯¾ç¨‹æ¨¡æ€æ¡†
        function closeEditCourseModal() {
            document.getElementById('editCourseModal').classList.remove('show');
            document.getElementById('editCourseForm').reset();
        }

        // ä¿å­˜è¯¾ç¨‹ç¼–è¾‘
        document.getElementById('editCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const courseId = document.getElementById('editCourseId').value;
            const formData = new FormData(e.target);
            const levelIds = Array.from(formData.getAll('levelIds'));
            
            const courseData = {
                name: document.getElementById('editCourseName').value,
                description: document.getElementById('editCourseDescription').value,
                levelIds: levelIds
            };

            try {
                console.log('å¼€å§‹æ›´æ–°è¯¾ç¨‹ï¼Œæ•°æ®:', courseData);
                const res = await fetch(`${API_BASE_URL}/courses/${courseId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });
                
                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    alert('æ›´æ–°å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status);
                    return;
                }
                
                const data = await res.json();
                console.log('å“åº”æ•°æ®:', data);
                
                if (data.success) {
                    alert('è¯¾ç¨‹æ›´æ–°æˆåŠŸï¼');
                    closeEditCourseModal();
                    loadCourses();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ›´æ–°è¯¾ç¨‹é”™è¯¯:', error);
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        });

        // åˆ é™¤è¯¾ç¨‹
        async function deleteCourse(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯¾ç¨‹å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/courses/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadCourses();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(id, message, success) {
            const msgEl = document.getElementById(id);
            msgEl.textContent = message;
            msgEl.className = `message ${success ? 'success' : 'error'} show`;
            setTimeout(() => {
                msgEl.classList.remove('show');
            }, 3000);
        }

        // åŠ è½½å…³å¡åˆ—è¡¨ï¼ˆç”¨äºç®¡ç†å…³å¡é¡µé¢ï¼‰
        async function loadLevelsList() {
            const container = document.getElementById('levelsList');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°levelsListå®¹å™¨');
                return;
            }
            
            try {
                console.log('å¼€å§‹åŠ è½½å…³å¡åˆ—è¡¨...');
                container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                
                const res = await fetch(`${API_BASE_URL}/levels`);
                console.log('å…³å¡åˆ—è¡¨å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    container.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: æœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status + '<br>è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000</div>';
                    return;
                }
                
                const data = await res.json();
                console.log('å…³å¡åˆ—è¡¨æ•°æ®:', data);
                console.log('å…³å¡æ•°é‡:', data.data ? data.data.length : 0);
                
                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        renderLevelsList(data.data);
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— å…³å¡ï¼Œè¯·å…ˆä¸Šä¼ å…³å¡</div>';
                    }
                } else {
                    container.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å…³å¡åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '<br>è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000</div>';
            }
        }

        // æ¸²æŸ“å…³å¡åˆ—è¡¨
        function renderLevelsList(levels) {
            const container = document.getElementById('levelsList');
            if (!container) return;
            
            if (levels.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— å…³å¡</div>';
                return;
            }
            
            container.innerHTML = levels.map((level, index) => {
                let contentHtml = '';
                
                if (level.type === 'image') {
                    contentHtml = `
                        <div class="level-info-item">
                            <label>å›¾ç‰‡æ•°é‡</label>
                            <div class="value">${level.images ? level.images.length : 0} å¼ </div>
                        </div>
                    `;
                } else if (level.type === 'video') {
                    contentHtml = `
                        <div class="level-info-item">
                            <label>è§†é¢‘</label>
                            <div class="value">${level.videoUrl ? 'å·²ä¸Šä¼ ' : 'æœªä¸Šä¼ '}</div>
                        </div>
                    `;
                } else if (level.type === 'canvas') {
                    contentHtml = `
                        <div class="level-info-item">
                            <label>ä»£ç </label>
                            <div class="value">${level.codeUrl || level.code ? 'å·²é…ç½®' : 'æœªé…ç½®'}</div>
                        </div>
                    `;
                } else if (level.type === 'quiz') {
                    const qCount = level.quiz && level.quiz.questions ? level.quiz.questions.length : 0;
                    contentHtml = `
                        <div class="level-info-item">
                            <label>é¢˜ç›®æ•°é‡</label>
                            <div class="value">${qCount} é¢˜</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="level-card">
                        <div class="level-card-header">
                            <div class="level-card-number">${index + 1}</div>
                            <div class="level-card-title">${level.title || 'æœªå‘½åå…³å¡'}</div>
                            <div class="level-card-actions">
                                <button class="btn-edit" onclick="editLevel('${level.id}')">ç¼–è¾‘</button>
                                <button class="btn-delete" onclick="deleteLevel('${level.id}')">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="level-card-info">
                            <div class="level-info-item">
                                <label>å…³å¡ç±»å‹</label>
                                <div class="value">
                                    <span class="level-badge badge-${level.type}">${getLevelTypeName(level.type)}</span>
                                </div>
                            </div>
                            <div class="level-info-item">
                                <label>æè¿°</label>
                                <div class="value">${level.description || 'æ— æè¿°'}</div>
                            </div>
                            <div class="level-info-item">
                                <label>åˆ›å»ºæ—¶é—´</label>
                                <div class="value">${level.createdAt ? new Date(level.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                            </div>
                            ${contentHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç¼–è¾‘å…³å¡
        async function editLevel(levelId) {
            try {
                const res = await fetch(`${API_BASE_URL}/levels/${levelId}`);
                const data = await res.json();
                
                if (data.success) {
                    const level = data.data;
                    document.getElementById('editLevelId').value = level.id;
                    document.getElementById('editLevelTitle').value = level.title || '';
                    document.getElementById('editLevelDescription').value = level.description || '';
                    
                    // æ ¹æ®å…³å¡ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç¼–è¾‘å†…å®¹
                    const contentDiv = document.getElementById('editLevelContent');
                    contentDiv.innerHTML = '';
                    
                    if (level.type === 'image') {
                        // ä¿å­˜åŸå§‹å›¾ç‰‡æ•°æ®ï¼Œç”¨äºåˆ é™¤æ“ä½œï¼ˆæ·±æ‹·è´ï¼‰
                        window.currentEditingLevel = {
                            ...level,
                            images: [...(level.images || [])],
                            texts: [...(level.texts || [])]
                        };
                        
                        contentDiv.innerHTML = `
                            <div class="form-group">
                                <label>å›¾ç‰‡è¯´æ˜æ–‡å­—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œå¯¹åº”æ¯å¼ å›¾ç‰‡ï¼‰</label>
                                <textarea id="editImageTexts" rows="5">${(level.texts || []).join('\n')}</textarea>
                            </div>
                            <div class="form-group">
                                <label>å½“å‰å›¾ç‰‡ï¼ˆç‚¹å‡»åˆ é™¤æŒ‰é’®å¯åˆ é™¤å›¾ç‰‡ï¼‰</label>
                                <div id="editImageList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                                    ${(level.images || []).map((img, i) => {
                                        // æ„å»ºå›¾ç‰‡URLï¼šæ”¯æŒBlob Storageå®Œæ•´URL
                                        const getImageUrl = (imgPath) => {
                                            if (!imgPath) return '';
                                            if (imgPath.startsWith('http://') || imgPath.startsWith('https://')) {
                                                return imgPath;
                                            }
                                            if (isLocal) {
                                                return `http://localhost:3000${imgPath}`;
                                            } else {
                                                if (imgPath.startsWith('/uploads/')) {
                                                    return `${API_BASE_URL}${imgPath}`;
                                                }
                                                return `${API_BASE_URL.replace('/api', '')}${imgPath}`;
                                            }
                                        };
                                        return `
                                        <div id="edit-image-${i}" style="position: relative;" data-image-index="${i}">
                                            <img src="${getImageUrl(img)}" 
                                                 style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #ddd;">
                                            <button type="button" class="btn-delete-image" onclick="deleteImageFromLevel(${i})" 
                                                    style="position: absolute; top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%; background: rgba(220, 38, 38, 0.9); color: white; border: none; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"
                                                    title="åˆ é™¤æ­¤å›¾ç‰‡">Ã—</button>
                                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 12px; text-align: center;">
                                                å›¾ç‰‡ ${i + 1}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <p style="font-size: 12px; color: #666; margin-top: 10px;">æç¤ºï¼šåˆ é™¤å›¾ç‰‡åï¼Œå¯¹åº”çš„è¯´æ˜æ–‡å­—ä¹Ÿä¼šè¢«åˆ é™¤</p>
                            </div>
                            <div class="form-group">
                                <label>æ·»åŠ æ–°å›¾ç‰‡</label>
                                <div class="file-upload" onclick="document.getElementById('editImageFile').click()" style="cursor: pointer; border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; background: #f9f9f9; transition: all 0.3s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#f0f7ff';" onmouseout="this.style.borderColor='#ddd'; this.style.background='#f9f9f9';">
                                    <p style="margin: 0; color: #666;">ğŸ“· ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ·»åŠ åˆ°å…³å¡</p>
                                    <input type="file" id="editImageFile" name="image" accept="image/*" style="display: none;" onchange="handleEditImageUpload(this.files)">
                                </div>
                                <div id="editImageUploadList" style="margin-top: 10px;"></div>
                            </div>
                        `;
                    } else if (level.type === 'video') {
                        contentDiv.innerHTML = `
                            <div class="form-group">
                                <label>å½“å‰è§†é¢‘</label>
                                ${level.videoUrl ? `
                                    <video controls style="width: 100%; max-width: 600px; margin-top: 10px; border-radius: 8px;">
                                        <source src="${API_BASE_URL.replace('/api', '')}${level.videoUrl}" type="video/mp4">
                                    </video>
                                    <p style="font-size: 12px; color: #666; margin-top: 10px;">æ³¨æ„ï¼šç¼–è¾‘æ—¶æ— æ³•ä¿®æ”¹è§†é¢‘ï¼Œå¦‚éœ€æ›´æ¢è§†é¢‘è¯·åˆ é™¤åé‡æ–°ä¸Šä¼ </p>
                                ` : '<p style="color: #999;">æœªä¸Šä¼ è§†é¢‘</p>'}
                            </div>
                        `;
                    } else if (level.type === 'canvas') {
                        contentDiv.innerHTML = `
                            <div class="form-group">
                                <label>å·²éƒ¨ç½²åº”ç”¨ URLï¼ˆå¯é€‰ï¼ŒReact ç­‰æ¨èç”¨ï¼‰</label>
                                <input type="url" id="editCanvasAppUrl" placeholder="https://..." value="${(level.appUrl || '').replace(/"/g, '&quot;')}">
                                <p style="font-size: 12px; color: #666; margin-top: 8px;">å¦‚æœä½ çš„ä»£ç åŒ…å« import React / npm åŒ…ï¼Œè¯·å¡«å·²éƒ¨ç½²URLï¼Œå­¦ç”Ÿç«¯å°†ç”¨ iframe æ‰“å¼€ã€‚</p>
                            </div>
                            <div class="form-group">
                                <label>Canvasä»£ç </label>
                                <textarea id="editCanvasCode" rows="15" style="font-family: monospace;">${level.code || ''}</textarea>
                                <p style="font-size: 12px; color: #666; margin-top: 10px;">ä¿®æ”¹ä»£ç åä¿å­˜å³å¯ç”Ÿæ•ˆ</p>
                            </div>
                        `;
                    } else if (level.type === 'quiz') {
                        const quizStr = JSON.stringify(level.quiz || { questions: [] }, null, 2);
                        contentDiv.innerHTML = `
                            <div class="form-group">
                                <label>é€‰æ‹©é¢˜JSON</label>
                                <textarea id="editQuizJson" rows="14" style="font-family: monospace;">${quizStr.replace(/</g, '&lt;')}</textarea>
                                <p style="font-size: 12px; color: #666; margin-top: 10px;">ä¿®æ”¹JSONåä¿å­˜å³å¯ç”Ÿæ•ˆã€‚æ ¼å¼é”™è¯¯ä¼šæç¤ºã€‚</p>
                            </div>
                        `;
                    }
                    
                    document.getElementById('editModal').classList.add('show');
                } else {
                    alert('åŠ è½½å…³å¡å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åŠ è½½å…³å¡å¤±è´¥:', error);
                alert('åŠ è½½å…³å¡å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            document.getElementById('editLevelForm').reset();
            window.currentEditingLevel = null; // æ¸…ç†ç¼–è¾‘çŠ¶æ€
        }

        // å¤„ç†ç¼–è¾‘é¡µé¢å›¾ç‰‡ä¸Šä¼ 
        window.handleEditImageUpload = async function(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            if (!window.currentEditingLevel) {
                alert('ç¼–è¾‘æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°æ‰“å¼€ç¼–è¾‘é¡µé¢');
                return;
            }
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            const uploadList = document.getElementById('editImageUploadList');
            const uploadId = 'upload-' + Date.now();
            uploadList.innerHTML = `<div id="${uploadId}" style="padding: 10px; background: #f0f7ff; border-radius: 6px; margin-bottom: 10px;">
                <p style="margin: 0; color: #3b82f6;">æ­£åœ¨ä¸Šä¼ : ${file.name}...</p>
            </div>`;
            
            try {
                // åˆ›å»ºFormDataä¸Šä¼ å›¾ç‰‡
                const formData = new FormData();
                formData.append('images', file);
                
                const res = await fetch(`${API_BASE_URL}/levels/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                // å…ˆå¤„ç†æ¥å£ä¸å­˜åœ¨ï¼ˆå¸¸è§åŸå› ï¼šåç«¯æœªé‡å¯ï¼Œä»åœ¨è·‘æ—§ä»£ç ï¼‰
                if (res.status === 404) {
                    throw new Error('æ¥å£ä¸å­˜åœ¨(404)ã€‚è¯·é‡å¯åç«¯æœåŠ¡åå†è¯•ï¼šå…³é—­ node server.js çª—å£åé‡æ–°å¯åŠ¨ã€‚');
                }

                // å…¼å®¹åç«¯éJSONé”™è¯¯ï¼ˆä¾‹å¦‚ 404/500 è¿”å›äº†HTMLï¼‰
                let data;
                const contentType = res.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    data = await res.json();
                } else {
                    const text = await res.text();
                    throw new Error('åç«¯è¿”å›äº†éJSONå“åº”ï¼š' + (text || '').slice(0, 120));
                }
                
                if (data.success && data.data && data.data.length > 0) {
                    // è·å–ä¸Šä¼ åçš„å›¾ç‰‡URL
                    const newImageUrl = data.data[0];
                    
                    // æ·»åŠ åˆ°å½“å‰ç¼–è¾‘çš„å…³å¡
                    if (!window.currentEditingLevel.images) {
                        window.currentEditingLevel.images = [];
                    }
                    window.currentEditingLevel.images.push(newImageUrl);
                    
                    // æ·»åŠ å¯¹åº”çš„ç©ºæ–‡æœ¬è¯´æ˜
                    if (!window.currentEditingLevel.texts) {
                        window.currentEditingLevel.texts = [];
                    }
                    window.currentEditingLevel.texts.push('');
                    
                    // æ›´æ–°æ–‡æœ¬åŒºåŸŸ
                    const textsTextarea = document.getElementById('editImageTexts');
                    if (textsTextarea) {
                        textsTextarea.value = window.currentEditingLevel.texts.join('\n');
                    }
                    
                    // é‡æ–°æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
                    renderEditImageList();
                    
                    // æ¸…é™¤ä¸Šä¼ çŠ¶æ€
                    uploadList.innerHTML = '';
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    document.getElementById('editImageFile').value = '';
                    
                    alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    throw new Error(data.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                uploadList.innerHTML = `<div style="padding: 10px; background: #fee; border-radius: 6px; color: #c33;">
                    <p style="margin: 0;">ä¸Šä¼ å¤±è´¥: ${error.message}</p>
                </div>`;
            }
        };
        
        // æ¸²æŸ“ç¼–è¾‘é¡µé¢çš„å›¾ç‰‡åˆ—è¡¨
        function renderEditImageList() {
            const imageListDiv = document.getElementById('editImageList');
            if (!imageListDiv || !window.currentEditingLevel) return;
            
            if (window.currentEditingLevel.images.length > 0) {
                // æ„å»ºå›¾ç‰‡URLï¼šæ”¯æŒBlob Storageå®Œæ•´URL
                const getImageUrl = (imgPath) => {
                    if (!imgPath) return '';
                    // å¦‚æœå·²ç»æ˜¯å®Œæ•´URLï¼ˆBlob Storageï¼‰ï¼Œç›´æ¥ä½¿ç”¨
                    if (imgPath.startsWith('http://') || imgPath.startsWith('https://')) {
                        return imgPath;
                    }
                    // ç›¸å¯¹è·¯å¾„ï¼šæ„å»ºå®Œæ•´URL
                    if (isLocal) {
                        return `http://localhost:3000${imgPath}`;
                    } else {
                        if (imgPath.startsWith('/uploads/')) {
                            return `${API_BASE_URL}${imgPath}`;
                        }
                        return `${API_BASE_URL.replace('/api', '')}${imgPath}`;
                    }
                };
                
                imageListDiv.innerHTML = window.currentEditingLevel.images.map((img, i) => `
                    <div id="edit-image-${i}" style="position: relative;" data-image-index="${i}">
                        <img src="${getImageUrl(img)}" 
                             style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #ddd;"
                             onerror="console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', '${img}'); this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23ddd\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3Eå›¾ç‰‡åŠ è½½å¤±è´¥%3C/text%3E%3C/svg%3E';">
                        <button type="button" class="btn-delete-image" onclick="deleteImageFromLevel(${i})" 
                                style="position: absolute; top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%; background: rgba(220, 38, 38, 0.9); color: white; border: none; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"
                                title="åˆ é™¤æ­¤å›¾ç‰‡">Ã—</button>
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 12px; text-align: center;">
                            å›¾ç‰‡ ${i + 1}
                        </div>
                    </div>
                `).join('');
            } else {
                imageListDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— å›¾ç‰‡</p>';
            }
        }

        // åˆ é™¤å›¾ç‰‡å…³å¡ä¸­çš„å›¾ç‰‡ï¼ˆç»‘å®šåˆ°windowå¯¹è±¡ï¼Œç¡®ä¿å…¨å±€å¯è®¿é—®ï¼‰
        window.deleteImageFromLevel = function(imageIndex) {
            if (!window.currentEditingLevel || !window.currentEditingLevel.images) {
                console.error('æ— æ³•åˆ é™¤å›¾ç‰‡ï¼šç¼–è¾‘æ•°æ®ä¸å­˜åœ¨');
                return;
            }
            
            if (imageIndex < 0 || imageIndex >= window.currentEditingLevel.images.length) {
                console.error('æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•:', imageIndex);
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¬¬ ${imageIndex + 1} å¼ å›¾ç‰‡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚`)) {
                return;
            }
            
            console.log('åˆ é™¤å›¾ç‰‡ï¼Œç´¢å¼•:', imageIndex);
            console.log('åˆ é™¤å‰å›¾ç‰‡æ•°é‡:', window.currentEditingLevel.images.length);
            
            // ä»æ•°ç»„ä¸­åˆ é™¤å›¾ç‰‡
            window.currentEditingLevel.images.splice(imageIndex, 1);
            
            // åŒæ­¥åˆ é™¤å¯¹åº”çš„è¯´æ˜æ–‡å­—
            if (window.currentEditingLevel.texts && window.currentEditingLevel.texts.length > imageIndex) {
                window.currentEditingLevel.texts.splice(imageIndex, 1);
            }
            
            console.log('åˆ é™¤åå›¾ç‰‡æ•°é‡:', window.currentEditingLevel.images.length);
            
            // æ›´æ–°æ–‡æœ¬åŒºåŸŸ
            const textsTextarea = document.getElementById('editImageTexts');
            if (textsTextarea) {
                textsTextarea.value = (window.currentEditingLevel.texts || []).join('\n');
            }
            
            // é‡æ–°æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
            renderEditImageList();
        };

        // ä¿å­˜ç¼–è¾‘
        document.getElementById('editLevelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const levelId = document.getElementById('editLevelId').value;
            const title = document.getElementById('editLevelTitle').value;
            const description = document.getElementById('editLevelDescription').value;
            
            try {
                // å…ˆè·å–åŸå§‹å…³å¡æ•°æ®
                const getRes = await fetch(`${API_BASE_URL}/levels/${levelId}`);
                const getData = await getRes.json();
                
                if (!getData.success) {
                    throw new Error('è·å–å…³å¡æ•°æ®å¤±è´¥');
                }
                
                const level = getData.data;
                let updateData = {
                    title: title,
                    description: description
                };
                
                // æ ¹æ®å…³å¡ç±»å‹å¤„ç†ç‰¹æ®Šå­—æ®µ
                if (level.type === 'image') {
                    // ä½¿ç”¨æ›´æ–°åçš„å›¾ç‰‡å’Œæ–‡æœ¬æ•°æ®
                    if (window.currentEditingLevel && window.currentEditingLevel.images) {
                        updateData.images = window.currentEditingLevel.images;
                        const textsTextarea = document.getElementById('editImageTexts');
                        if (textsTextarea) {
                            const texts = textsTextarea.value.split('\n').filter(t => t.trim());
                            // ç¡®ä¿æ–‡æœ¬æ•°é‡ä¸å›¾ç‰‡æ•°é‡åŒ¹é…
                            while (texts.length < updateData.images.length) {
                                texts.push('');
                            }
                            updateData.texts = texts.slice(0, updateData.images.length);
                        } else {
                            updateData.texts = window.currentEditingLevel.texts || [];
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰currentEditingLevelï¼Œä¿æŒåŸæœ‰å›¾ç‰‡
                        updateData.images = level.images || [];
                        const textsTextarea = document.getElementById('editImageTexts');
                        if (textsTextarea) {
                            const texts = textsTextarea.value.split('\n').filter(t => t.trim());
                            updateData.texts = texts;
                        }
                    }
                } else if (level.type === 'canvas') {
                    const codeTextarea = document.getElementById('editCanvasCode');
                    if (codeTextarea) {
                        updateData.code = codeTextarea.value;
                    }
                    const appUrlInput = document.getElementById('editCanvasAppUrl');
                    if (appUrlInput) {
                        updateData.appUrl = appUrlInput.value;
                    }
                } else if (level.type === 'quiz') {
                    const quizTextarea = document.getElementById('editQuizJson');
                    if (quizTextarea) {
                        const raw = quizTextarea.value.trim();
                        if (!raw) {
                            throw new Error('é€‰æ‹©é¢˜JSONä¸èƒ½ä¸ºç©º');
                        }
                        // è¿™é‡Œå…ˆåœ¨å‰ç«¯åšä¸€æ¬¡JSONæ ¡éªŒï¼Œåç«¯ä¹Ÿä¼šå†æ¬¡æ ¡éªŒ
                        try {
                            const parsed = JSON.parse(raw);
                            updateData.quiz = parsed;
                        } catch (e) {
                            throw new Error('é€‰æ‹©é¢˜JSONæ ¼å¼é”™è¯¯ï¼š' + e.message);
                        }
                    }
                }
                
                // ä½¿ç”¨PUTæ¥å£æ›´æ–°å…³å¡
                const updateRes = await fetch(`${API_BASE_URL}/levels/${levelId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                console.log('æ›´æ–°å“åº”çŠ¶æ€:', updateRes.status);
                
                if (!updateRes.ok) {
                    const errorText = await updateRes.text();
                    console.error('æ›´æ–°é”™è¯¯:', errorText);
                    throw new Error('æœåŠ¡å™¨è¿”å›é”™è¯¯: ' + updateRes.status);
                }
                
                const updateData_result = await updateRes.json();
                console.log('æ›´æ–°ç»“æœ:', updateData_result);
                
                if (updateData_result.success) {
                    showMessage('uploadMessage', 'ä¿®æ”¹æˆåŠŸï¼', true);
                    closeEditModal();
                    loadLevelsList();
                    loadLevels(); // åˆ·æ–°åˆ›å»ºè¯¾ç¨‹é¡µé¢çš„å…³å¡åˆ—è¡¨
                } else {
                    throw new Error(updateData_result.message || 'ä¿®æ”¹å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // åˆ é™¤å…³å¡
        async function deleteLevel(levelId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…³å¡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/levels/${levelId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadLevelsList();
                    loadLevels(); // åˆ·æ–°åˆ›å»ºè¯¾ç¨‹é¡µé¢çš„å…³å¡åˆ—è¡¨
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadLevels();
            loadCourses();
        });
    </script>
</body>
</html>
