<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹ç®¡ç† - AIå­¦ä¹ è¯¾ç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'SimHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-upload input {
            display: none;
        }

        .file-list {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .image-item {
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            border: 2px solid #e0e0e0;
        }

        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .image-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-item .delete-btn:hover {
            background: #c82333;
        }

        .image-item .text-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 5px;
        }

        .image-item .file-name {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            word-break: break-all;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .level-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .level-list-container {
            margin-top: 20px;
        }

        .level-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .level-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .level-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .level-card-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 20px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .level-card-title {
            flex: 1;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }

        .level-card-actions {
            display: flex;
            gap: 10px;
        }

        .btn-edit {
            background: #28a745;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-edit:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .level-card-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .level-info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .level-info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .level-info-item .value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* ç¼–è¾‘æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            color: #333;
            margin: 0;
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            line-height: 35px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: #333;
            background: #f0f0f0;
        }

        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .badge-image {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-video {
            background: #fce4ec;
            color: #c2185b;
        }

        .badge-canvas {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .course-list {
            margin-top: 20px;
        }

        .course-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }

        .course-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .checkbox-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
        }

        .checkbox-item input {
            width: auto;
            margin-right: 10px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š è¯¾ç¨‹ç®¡ç†ç³»ç»Ÿ</h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">ä¸Šä¼ å…³å¡</button>
            <button class="tab" onclick="switchTab('course')">åˆ›å»ºè¯¾ç¨‹</button>
            <button class="tab" onclick="switchTab('manage')">ç®¡ç†è¯¾ç¨‹</button>
            <button class="tab" onclick="switchTab('levels')">ç®¡ç†å…³å¡</button>
        </div>

        <!-- ä¸Šä¼ å…³å¡ -->
        <div id="uploadTab" class="tab-content active">
            <h2>ä¸Šä¼ å…³å¡</h2>
            
            <div class="message" id="uploadMessage"></div>

            <div class="tabs" style="margin-top: 20px;">
                <button class="tab active" onclick="switchLevelType('image')">å›¾ç‰‡å…³å¡</button>
                <button class="tab" onclick="switchLevelType('video')">è§†é¢‘å…³å¡</button>
                <button class="tab" onclick="switchLevelType('canvas')">Canvaså…³å¡</button>
            </div>

            <!-- å›¾ç‰‡å…³å¡è¡¨å• -->
            <form id="imageForm" class="level-form">
                <div class="form-group">
                    <label>å…³å¡æ ‡é¢˜</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>å…³å¡æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡ï¼ˆä¸€å¼ ä¸€å¼ ä¸Šä¼ ï¼‰</label>
                    <div class="file-upload" onclick="document.getElementById('imageFile').click()">
                        <p>ğŸ“· ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</p>
                        <input type="file" id="imageFile" name="image" accept="image/*" onchange="handleSingleImage(this.files)">
                    </div>
                    <div class="file-list" id="imageFileList"></div>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ å›¾ç‰‡å…³å¡</button>
            </form>

            <!-- è§†é¢‘å…³å¡è¡¨å• -->
            <form id="videoForm" class="level-form" style="display: none;">
                <div class="form-group">
                    <label>å…³å¡æ ‡é¢˜</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>å…³å¡æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ è§†é¢‘</label>
                    <div class="file-upload" onclick="document.getElementById('videoFile').click()">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘åˆ°è¿™é‡Œ</p>
                        <input type="file" id="videoFile" name="video" accept="video/*" onchange="handleVideoFile(this.files)">
                    </div>
                    <div class="file-list" id="videoFileList"></div>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ è§†é¢‘å…³å¡</button>
            </form>

            <!-- Canvaså…³å¡è¡¨å• -->
            <form id="canvasForm" class="level-form" style="display: none;">
                <div class="form-group">
                    <label>å…³å¡æ ‡é¢˜</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>å…³å¡æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>Canvasä»£ç </label>
                    <textarea name="code" rows="15" placeholder="// åœ¨è¿™é‡Œè¾“å…¥Canvasä»£ç &#10;// ä¾‹å¦‚ï¼š&#10;const canvas = document.getElementById('canvas');&#10;const ctx = canvas.getContext('2d');&#10;// ..."></textarea>
                </div>
                <div class="form-group">
                    <label>æˆ–ä¸Šä¼ ä»£ç æ–‡ä»¶</label>
                    <div class="file-upload" onclick="document.getElementById('canvasFile').click()">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä»£ç æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                        <input type="file" id="canvasFile" name="canvas" accept=".js,.html" onchange="handleCanvasFile(this.files)">
                    </div>
                    <div class="file-list" id="canvasFileList"></div>
                </div>
                <button type="submit" class="btn btn-primary">ä¸Šä¼ Canvaså…³å¡</button>
            </form>
        </div>

        <!-- åˆ›å»ºè¯¾ç¨‹ -->
        <div id="courseTab" class="tab-content">
            <h2>åˆ›å»ºè¯¾ç¨‹</h2>
            
            <div class="message" id="courseMessage"></div>

            <form id="courseForm">
                <div class="form-group">
                    <label>è¯¾ç¨‹åç§°</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>è¯¾ç¨‹æè¿°</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©å…³å¡ï¼ˆæŒ‰ä½Ctrlå¯å¤šé€‰ï¼‰</label>
                    <div class="checkbox-list" id="levelCheckboxes">
                        <div class="loading">åŠ è½½å…³å¡ä¸­...</div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">åˆ›å»ºè¯¾ç¨‹</button>
            </form>
        </div>

        <!-- ç®¡ç†è¯¾ç¨‹ -->
        <div id="manageTab" class="tab-content">
            <h2>ç®¡ç†è¯¾ç¨‹</h2>
            <div id="courseList" class="course-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç¼–è¾‘è¯¾ç¨‹æ¨¡æ€æ¡† -->
        <div id="editCourseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¼–è¾‘è¯¾ç¨‹</h3>
                    <button class="close-modal" onclick="closeEditCourseModal()">&times;</button>
                </div>
                <form id="editCourseForm">
                    <input type="hidden" id="editCourseId">
                    <div class="form-group">
                        <label>è¯¾ç¨‹åç§°</label>
                        <input type="text" id="editCourseName" required>
                    </div>
                    <div class="form-group">
                        <label>è¯¾ç¨‹æè¿°</label>
                        <textarea id="editCourseDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©å…³å¡ï¼ˆæŒ‰ä½Ctrlå¯å¤šé€‰ï¼‰</label>
                        <div class="checkbox-list" id="editCourseLevelCheckboxes">
                            <div class="loading">åŠ è½½å…³å¡ä¸­...</div>
                        </div>
                    </div>
                    <div class="button-area" style="margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeEditCourseModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç®¡ç†å…³å¡ -->
        <div id="levelsTab" class="tab-content">
            <h2>ç®¡ç†å…³å¡</h2>
            <div id="levelsList" class="level-list-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ç¼–è¾‘å…³å¡æ¨¡æ€æ¡† -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¼–è¾‘å…³å¡</h3>
                    <button class="close-modal" onclick="closeEditModal()">&times;</button>
                </div>
                <form id="editLevelForm">
                    <input type="hidden" id="editLevelId">
                    <div class="form-group">
                        <label>å…³å¡æ ‡é¢˜</label>
                        <input type="text" id="editLevelTitle" required>
                    </div>
                    <div class="form-group">
                        <label>å…³å¡æè¿°</label>
                        <textarea id="editLevelDescription"></textarea>
                    </div>
                    <div id="editLevelContent"></div>
                    <div class="button-area" style="margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let imageItems = []; // å­˜å‚¨å›¾ç‰‡é¡¹ï¼š{file, preview, text}
        let selectedVideoFile = null;
        let selectedCanvasFile = null;

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // æ‰¾åˆ°å¯¹åº”çš„tabæŒ‰é’®å¹¶æ¿€æ´»
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((t) => {
                const onclickAttr = t.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`switchTab('${tab}')`)) {
                    t.classList.add('active');
                }
            });
            
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°åˆ›å»ºè¯¾ç¨‹æ ‡ç­¾ï¼Œåˆ·æ–°å…³å¡åˆ—è¡¨
            if (tab === 'course') {
                loadLevels();
            }
            // å¦‚æœåˆ‡æ¢åˆ°ç®¡ç†å…³å¡æ ‡ç­¾ï¼ŒåŠ è½½å…³å¡åˆ—è¡¨
            if (tab === 'levels') {
                loadLevelsList();
            }
            // å¦‚æœåˆ‡æ¢åˆ°ç®¡ç†è¯¾ç¨‹æ ‡ç­¾ï¼ŒåŠ è½½è¯¾ç¨‹åˆ—è¡¨
            if (tab === 'manage') {
                loadCourses();
            }
        }

        // åˆ‡æ¢å…³å¡ç±»å‹
        function switchLevelType(type) {
            document.querySelectorAll('.level-form').forEach(f => f.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(type + 'Form').style.display = 'block';
        }

        // å¤„ç†å•å¼ å›¾ç‰‡ä¸Šä¼ 
        function handleSingleImage(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            if (!file.type.startsWith('image/')) {
                showMessage('uploadMessage', 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', false);
                return;
            }
            
            // åˆ›å»ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageItem = {
                    id: Date.now(),
                    file: file,
                    preview: e.target.result,
                    text: ''
                };
                
                imageItems.push(imageItem);
                renderImageList();
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                document.getElementById('imageFile').value = '';
            };
            reader.readAsDataURL(file);
        }

        // æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
        function renderImageList() {
            const list = document.getElementById('imageFileList');
            if (imageItems.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = imageItems.map((item, index) => `
                <div class="image-item">
                    <button type="button" class="delete-btn" onclick="removeImageItem(${index})" title="åˆ é™¤">Ã—</button>
                    <img src="${item.preview}" alt="${item.file.name}">
                    <div class="file-name">${item.file.name}</div>
                    <input type="text" 
                           class="text-input" 
                           placeholder="å›¾ç‰‡è¯´æ˜æ–‡å­—" 
                           value="${item.text}"
                           onchange="updateImageText(${index}, this.value)">
                </div>
            `).join('');
        }

        // æ›´æ–°å›¾ç‰‡è¯´æ˜æ–‡å­—
        function updateImageText(index, text) {
            if (imageItems[index]) {
                imageItems[index].text = text;
            }
        }

        // åˆ é™¤å›¾ç‰‡é¡¹
        function removeImageItem(index) {
            imageItems.splice(index, 1);
            renderImageList();
        }

        // å¤„ç†è§†é¢‘æ–‡ä»¶
        function handleVideoFile(files) {
            selectedVideoFile = files[0];
            const list = document.getElementById('videoFileList');
            list.innerHTML = selectedVideoFile ? 
                `<div class="file-item">
                    <span>${selectedVideoFile.name}</span>
                    <button type="button" onclick="removeVideoFile()">åˆ é™¤</button>
                </div>` : '';
        }

        function removeVideoFile() {
            selectedVideoFile = null;
            document.getElementById('videoFile').value = '';
            document.getElementById('videoFileList').innerHTML = '';
        }

        // å¤„ç†Canvasæ–‡ä»¶
        function handleCanvasFile(files) {
            selectedCanvasFile = files[0];
            const list = document.getElementById('canvasFileList');
            list.innerHTML = selectedCanvasFile ? 
                `<div class="file-item">
                    <span>${selectedCanvasFile.name}</span>
                    <button type="button" onclick="removeCanvasFile()">åˆ é™¤</button>
                </div>` : '';
        }

        function removeCanvasFile() {
            selectedCanvasFile = null;
            document.getElementById('canvasFile').value = '';
            document.getElementById('canvasFileList').innerHTML = '';
        }

        // ä¸Šä¼ å›¾ç‰‡å…³å¡
        document.getElementById('imageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (imageItems.length === 0) {
                showMessage('uploadMessage', 'è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å›¾ç‰‡', false);
                return;
            }
            
            const formData = new FormData();
            formData.append('title', e.target.title.value);
            formData.append('description', e.target.description.value);
            
            // æ·»åŠ æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
            imageItems.forEach(item => {
                formData.append('images', item.file);
            });
            
            // æ·»åŠ è¯´æ˜æ–‡å­—æ•°ç»„
            const texts = imageItems.map(item => item.text || '');
            formData.append('texts', JSON.stringify(texts));

            try {
                console.log('å¼€å§‹ä¸Šä¼ å›¾ç‰‡å…³å¡ï¼Œå›¾ç‰‡æ•°é‡:', imageItems.length);
                const res = await fetch(`${API_BASE_URL}/levels/image`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status, false);
                    return;
                }
                
                const data = await res.json();
                console.log('å“åº”æ•°æ®:', data);
                
                showMessage('uploadMessage', data.success ? 'ä¸Šä¼ æˆåŠŸï¼' : 'ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), data.success);
                if (data.success) {
                    e.target.reset();
                    imageItems = [];
                    renderImageList();
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼š' + error.message + 'ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000', false);
            }
        });

        // ä¸Šä¼ è§†é¢‘å…³å¡
        document.getElementById('videoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', e.target.title.value);
            formData.append('description', e.target.description.value);
            
            if (selectedVideoFile) {
                formData.append('video', selectedVideoFile);
            }

            try {
                console.log('å¼€å§‹ä¸Šä¼ è§†é¢‘å…³å¡');
                const res = await fetch(`${API_BASE_URL}/levels/video`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status, false);
                    return;
                }
                
                const data = await res.json();
                console.log('å“åº”æ•°æ®:', data);
                
                showMessage('uploadMessage', data.success ? 'ä¸Šä¼ æˆåŠŸï¼' : 'ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), data.success);
                if (data.success) {
                    e.target.reset();
                    removeVideoFile();
                    // åˆ·æ–°å…³å¡åˆ—è¡¨
                    loadLevels();
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼š' + error.message + 'ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000', false);
            }
        });

        // ä¸Šä¼ Canvaså…³å¡
        document.getElementById('canvasForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', e.target.title.value);
            formData.append('description', e.target.description.value);
            formData.append('code', e.target.code.value);
            
            if (selectedCanvasFile) {
                formData.append('canvas', selectedCanvasFile);
            }

            try {
                console.log('å¼€å§‹ä¸Šä¼ Canvaså…³å¡');
                const res = await fetch(`${API_BASE_URL}/levels/canvas`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status, false);
                    return;
                }
                
                const data = await res.json();
                console.log('å“åº”æ•°æ®:', data);
                
                showMessage('uploadMessage', data.success ? 'ä¸Šä¼ æˆåŠŸï¼' : 'ä¸Šä¼ å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), data.success);
                if (data.success) {
                    e.target.reset();
                    removeCanvasFile();
                    // åˆ·æ–°å…³å¡åˆ—è¡¨
                    loadLevels();
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                showMessage('uploadMessage', 'ä¸Šä¼ å¤±è´¥ï¼š' + error.message + 'ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000', false);
            }
        });

        // åŠ è½½å…³å¡åˆ—è¡¨
        async function loadLevels() {
            const container = document.getElementById('levelCheckboxes');
            if (!container) return;
            
            try {
                console.log('å¼€å§‹åŠ è½½å…³å¡åˆ—è¡¨...');
                container.innerHTML = '<div class="loading">åŠ è½½å…³å¡ä¸­...</div>';
                
                const res = await fetch(`${API_BASE_URL}/levels`);
                console.log('å…³å¡åˆ—è¡¨å“åº”çŠ¶æ€:', res.status);
                
                if (!res.ok) {
                    throw new Error('æœåŠ¡å™¨è¿”å›é”™è¯¯: ' + res.status);
                }
                
                const data = await res.json();
                console.log('å…³å¡åˆ—è¡¨æ•°æ®:', data);
                
                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        renderLevelCheckboxes(data.data);
                    } else {
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— å…³å¡ï¼Œè¯·å…ˆä¸Šä¼ å…³å¡</div>';
                    }
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #c33;">åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å…³å¡å¤±è´¥:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #c33;">åŠ è½½å¤±è´¥: ' + error.message + '<br>è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ</div>';
            }
        }

        // æ¸²æŸ“å…³å¡å¤é€‰æ¡†
        function renderLevelCheckboxes(levels) {
            const container = document.getElementById('levelCheckboxes');
            if (!container) return;
            
            if (levels.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— å…³å¡</div>';
                return;
            }
            
            container.innerHTML = levels.map(level => `
                <div class="checkbox-item">
                    <input type="checkbox" name="levelIds" value="${level.id}" id="level-${level.id}">
                    <label for="level-${level.id}">
                        <strong>${level.title || 'æœªå‘½åå…³å¡'}</strong> 
                        <span class="level-badge badge-${level.type}">${getLevelTypeName(level.type)}</span>
                    </label>
                </div>
            `).join('');
        }

        function getLevelTypeName(type) {
            const names = {
                'image': 'å›¾ç‰‡',
                'video': 'è§†é¢‘',
                'canvas': 'Canvas'
            };
            return names[type] || type;
        }

        // åˆ›å»ºè¯¾ç¨‹
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const levelIds = Array.from(formData.getAll('levelIds'));
            
            const courseData = {
                name: formData.get('name'),
                description: formData.get('description'),
                levelIds: levelIds
            };

            try {
                const res = await fetch(`${API_BASE_URL}/courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });
                const data = await res.json();
                showMessage('courseMessage', data.success ? 'è¯¾ç¨‹åˆ›å»ºæˆåŠŸï¼' : 'åˆ›å»ºå¤±è´¥ï¼š' + data.message, data.success);
                if (data.success) {
                    e.target.reset();
                    loadCourses();
                }
            } catch (error) {
                showMessage('courseMessage', 'åˆ›å»ºå¤±è´¥ï¼š' + error.message, false);
            }
        });

        // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
        async function loadCourses() {
            try {
                const res = await fetch(`${API_BASE_URL}/courses`);
                const data = await res.json();
                if (data.success) {
                    renderCourses(data.data);
                }
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“è¯¾ç¨‹åˆ—è¡¨
        function renderCourses(courses) {
            const container = document.getElementById('courseList');
            if (courses.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— è¯¾ç¨‹</div>';
                return;
            }
            
            container.innerHTML = courses.map((course, index) => `
                <div class="course-item">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                <div style="width: 40px; height: 40px; line-height: 40px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 50%; font-weight: bold;">
                                    ${index + 1}
                                </div>
                                <h3 style="margin: 0;">${course.name}</h3>
                            </div>
                            <p style="color: #666; margin-bottom: 10px;">${course.description || 'æ— æè¿°'}</p>
                            <p style="font-size: 14px; color: #666;">åŒ…å« ${course.levelIds.length} ä¸ªå…³å¡</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-edit" onclick="editCourse('${course.id}')">ç¼–è¾‘</button>
                            <button class="btn-delete" onclick="deleteCourse('${course.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ç¼–è¾‘è¯¾ç¨‹
        async function editCourse(courseId) {
            try {
                // åŠ è½½è¯¾ç¨‹æ•°æ®
                const courseRes = await fetch(`${API_BASE_URL}/courses/${courseId}`);
                const courseData = await courseRes.json();
                
                if (!courseData.success) {
                    alert('åŠ è½½è¯¾ç¨‹å¤±è´¥: ' + courseData.message);
                    return;
                }
                
                const course = courseData.data;
                document.getElementById('editCourseId').value = course.id;
                document.getElementById('editCourseName').value = course.name || '';
                document.getElementById('editCourseDescription').value = course.description || '';
                
                // åŠ è½½å…³å¡åˆ—è¡¨å¹¶é€‰ä¸­å½“å‰è¯¾ç¨‹çš„å…³å¡
                const levelsRes = await fetch(`${API_BASE_URL}/levels`);
                const levelsData = await levelsRes.json();
                
                if (levelsData.success) {
                    renderEditCourseLevelCheckboxes(levelsData.data, course.levelIds || []);
                }
                
                document.getElementById('editCourseModal').classList.add('show');
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
                alert('åŠ è½½è¯¾ç¨‹å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“ç¼–è¾‘è¯¾ç¨‹çš„å…³å¡å¤é€‰æ¡†
        function renderEditCourseLevelCheckboxes(levels, selectedLevelIds) {
            const container = document.getElementById('editCourseLevelCheckboxes');
            if (!container) return;
            
            if (levels.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— å…³å¡</div>';
                return;
            }
            
            container.innerHTML = levels.map(level => {
                const isChecked = selectedLevelIds.includes(level.id);
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" name="levelIds" value="${level.id}" id="edit-level-${level.id}" ${isChecked ? 'checked' : ''}>
                        <label for="edit-level-${level.id}">
                            <strong>${level.title || 'æœªå‘½åå…³å¡'}</strong> 
                            <span class="level-badge badge-${level.type}">${getLevelTypeName(level.type)}</span>
                        </label>
                    </div>
                `;
            }).join('');
        }

        // å…³é—­ç¼–è¾‘è¯¾ç¨‹æ¨¡æ€æ¡†
        function closeEditCourseModal() {
            document.getElementById('editCourseModal').classList.remove('show');
            document.getElementById('editCourseForm').reset();
        }

        // ä¿å­˜è¯¾ç¨‹ç¼–è¾‘
        document.getElementById('editCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const courseId = document.getElementById('editCourseId').value;
            const formData = new FormData(e.target);
            const levelIds = Array.from(formData.getAll('levelIds'));
            
            const courseData = {
                name: document.getElementById('editCourseName').value,
                description: document.getElementById('editCourseDescription').value,
                levelIds: levelIds
            };

            try {
                console.log('å¼€å§‹æ›´æ–°è¯¾ç¨‹ï¼Œæ•°æ®:', courseData);
                const res = await fetch(`${API_BASE_URL}/courses/${courseId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });
                
                console.log('å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    alert('æ›´æ–°å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status);
                    return;
                }
                
                const data = await res.json();
                console.log('å“åº”æ•°æ®:', data);
                
                if (data.success) {
                    alert('è¯¾ç¨‹æ›´æ–°æˆåŠŸï¼');
                    closeEditCourseModal();
                    loadCourses();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ›´æ–°è¯¾ç¨‹é”™è¯¯:', error);
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        });

        // åˆ é™¤è¯¾ç¨‹
        async function deleteCourse(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯¾ç¨‹å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/courses/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadCourses();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(id, message, success) {
            const msgEl = document.getElementById(id);
            msgEl.textContent = message;
            msgEl.className = `message ${success ? 'success' : 'error'} show`;
            setTimeout(() => {
                msgEl.classList.remove('show');
            }, 3000);
        }

        // åŠ è½½å…³å¡åˆ—è¡¨ï¼ˆç”¨äºç®¡ç†å…³å¡é¡µé¢ï¼‰
        async function loadLevelsList() {
            const container = document.getElementById('levelsList');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°levelsListå®¹å™¨');
                return;
            }
            
            try {
                console.log('å¼€å§‹åŠ è½½å…³å¡åˆ—è¡¨...');
                container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                
                const res = await fetch(`${API_BASE_URL}/levels`);
                console.log('å…³å¡åˆ—è¡¨å“åº”çŠ¶æ€:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    container.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: æœåŠ¡å™¨è¿”å›é”™è¯¯ ' + res.status + '<br>è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000</div>';
                    return;
                }
                
                const data = await res.json();
                console.log('å…³å¡åˆ—è¡¨æ•°æ®:', data);
                console.log('å…³å¡æ•°é‡:', data.data ? data.data.length : 0);
                
                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        renderLevelsList(data.data);
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— å…³å¡ï¼Œè¯·å…ˆä¸Šä¼ å…³å¡</div>';
                    }
                } else {
                    container.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å…³å¡åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '<br>è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000</div>';
            }
        }

        // æ¸²æŸ“å…³å¡åˆ—è¡¨
        function renderLevelsList(levels) {
            const container = document.getElementById('levelsList');
            if (!container) return;
            
            if (levels.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— å…³å¡</div>';
                return;
            }
            
            container.innerHTML = levels.map((level, index) => {
                let contentHtml = '';
                
                if (level.type === 'image') {
                    contentHtml = `
                        <div class="level-info-item">
                            <label>å›¾ç‰‡æ•°é‡</label>
                            <div class="value">${level.images ? level.images.length : 0} å¼ </div>
                        </div>
                    `;
                } else if (level.type === 'video') {
                    contentHtml = `
                        <div class="level-info-item">
                            <label>è§†é¢‘</label>
                            <div class="value">${level.videoUrl ? 'å·²ä¸Šä¼ ' : 'æœªä¸Šä¼ '}</div>
                        </div>
                    `;
                } else if (level.type === 'canvas') {
                    contentHtml = `
                        <div class="level-info-item">
                            <label>ä»£ç </label>
                            <div class="value">${level.codeUrl || level.code ? 'å·²é…ç½®' : 'æœªé…ç½®'}</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="level-card">
                        <div class="level-card-header">
                            <div class="level-card-number">${index + 1}</div>
                            <div class="level-card-title">${level.title || 'æœªå‘½åå…³å¡'}</div>
                            <div class="level-card-actions">
                                <button class="btn-edit" onclick="editLevel('${level.id}')">ç¼–è¾‘</button>
                                <button class="btn-delete" onclick="deleteLevel('${level.id}')">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="level-card-info">
                            <div class="level-info-item">
                                <label>å…³å¡ç±»å‹</label>
                                <div class="value">
                                    <span class="level-badge badge-${level.type}">${getLevelTypeName(level.type)}</span>
                                </div>
                            </div>
                            <div class="level-info-item">
                                <label>æè¿°</label>
                                <div class="value">${level.description || 'æ— æè¿°'}</div>
                            </div>
                            <div class="level-info-item">
                                <label>åˆ›å»ºæ—¶é—´</label>
                                <div class="value">${level.createdAt ? new Date(level.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                            </div>
                            ${contentHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç¼–è¾‘å…³å¡
        async function editLevel(levelId) {
            try {
                const res = await fetch(`${API_BASE_URL}/levels/${levelId}`);
                const data = await res.json();
                
                if (data.success) {
                    const level = data.data;
                    document.getElementById('editLevelId').value = level.id;
                    document.getElementById('editLevelTitle').value = level.title || '';
                    document.getElementById('editLevelDescription').value = level.description || '';
                    
                    // æ ¹æ®å…³å¡ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç¼–è¾‘å†…å®¹
                    const contentDiv = document.getElementById('editLevelContent');
                    contentDiv.innerHTML = '';
                    
                    if (level.type === 'image') {
                        contentDiv.innerHTML = `
                            <div class="form-group">
                                <label>å›¾ç‰‡è¯´æ˜æ–‡å­—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œå¯¹åº”æ¯å¼ å›¾ç‰‡ï¼‰</label>
                                <textarea id="editImageTexts" rows="5">${(level.texts || []).join('\n')}</textarea>
                            </div>
                            <div class="form-group">
                                <label>å½“å‰å›¾ç‰‡</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                                    ${(level.images || []).map((img, i) => `
                                        <div style="position: relative;">
                                            <img src="${API_BASE_URL.replace('/api', '')}${img}" 
                                                 style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #ddd;">
                                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 12px; text-align: center;">
                                                å›¾ç‰‡ ${i + 1}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <p style="font-size: 12px; color: #666; margin-top: 10px;">æ³¨æ„ï¼šç¼–è¾‘æ—¶æ— æ³•ä¿®æ”¹å›¾ç‰‡ï¼Œå¦‚éœ€æ›´æ¢å›¾ç‰‡è¯·åˆ é™¤åé‡æ–°ä¸Šä¼ </p>
                            </div>
                        `;
                    } else if (level.type === 'video') {
                        contentDiv.innerHTML = `
                            <div class="form-group">
                                <label>å½“å‰è§†é¢‘</label>
                                ${level.videoUrl ? `
                                    <video controls style="width: 100%; max-width: 600px; margin-top: 10px; border-radius: 8px;">
                                        <source src="${API_BASE_URL.replace('/api', '')}${level.videoUrl}" type="video/mp4">
                                    </video>
                                    <p style="font-size: 12px; color: #666; margin-top: 10px;">æ³¨æ„ï¼šç¼–è¾‘æ—¶æ— æ³•ä¿®æ”¹è§†é¢‘ï¼Œå¦‚éœ€æ›´æ¢è§†é¢‘è¯·åˆ é™¤åé‡æ–°ä¸Šä¼ </p>
                                ` : '<p style="color: #999;">æœªä¸Šä¼ è§†é¢‘</p>'}
                            </div>
                        `;
                    } else if (level.type === 'canvas') {
                        contentDiv.innerHTML = `
                            <div class="form-group">
                                <label>Canvasä»£ç </label>
                                <textarea id="editCanvasCode" rows="15" style="font-family: monospace;">${level.code || ''}</textarea>
                                <p style="font-size: 12px; color: #666; margin-top: 10px;">ä¿®æ”¹ä»£ç åä¿å­˜å³å¯ç”Ÿæ•ˆ</p>
                            </div>
                        `;
                    }
                    
                    document.getElementById('editModal').classList.add('show');
                } else {
                    alert('åŠ è½½å…³å¡å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åŠ è½½å…³å¡å¤±è´¥:', error);
                alert('åŠ è½½å…³å¡å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            document.getElementById('editLevelForm').reset();
        }

        // ä¿å­˜ç¼–è¾‘
        document.getElementById('editLevelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const levelId = document.getElementById('editLevelId').value;
            const title = document.getElementById('editLevelTitle').value;
            const description = document.getElementById('editLevelDescription').value;
            
            try {
                // å…ˆè·å–åŸå§‹å…³å¡æ•°æ®
                const getRes = await fetch(`${API_BASE_URL}/levels/${levelId}`);
                const getData = await getRes.json();
                
                if (!getData.success) {
                    throw new Error('è·å–å…³å¡æ•°æ®å¤±è´¥');
                }
                
                const level = getData.data;
                let updateData = {
                    title: title,
                    description: description
                };
                
                // æ ¹æ®å…³å¡ç±»å‹å¤„ç†ç‰¹æ®Šå­—æ®µ
                if (level.type === 'image') {
                    const textsTextarea = document.getElementById('editImageTexts');
                    if (textsTextarea) {
                        const texts = textsTextarea.value.split('\n').filter(t => t.trim());
                        updateData.texts = texts;
                    }
                } else if (level.type === 'canvas') {
                    const codeTextarea = document.getElementById('editCanvasCode');
                    if (codeTextarea) {
                        updateData.code = codeTextarea.value;
                    }
                }
                
                // ä½¿ç”¨PUTæ¥å£æ›´æ–°å…³å¡
                const updateRes = await fetch(`${API_BASE_URL}/levels/${levelId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                console.log('æ›´æ–°å“åº”çŠ¶æ€:', updateRes.status);
                
                if (!updateRes.ok) {
                    const errorText = await updateRes.text();
                    console.error('æ›´æ–°é”™è¯¯:', errorText);
                    throw new Error('æœåŠ¡å™¨è¿”å›é”™è¯¯: ' + updateRes.status);
                }
                
                const updateData_result = await updateRes.json();
                console.log('æ›´æ–°ç»“æœ:', updateData_result);
                
                if (updateData_result.success) {
                    showMessage('uploadMessage', 'ä¿®æ”¹æˆåŠŸï¼', true);
                    closeEditModal();
                    loadLevelsList();
                    loadLevels(); // åˆ·æ–°åˆ›å»ºè¯¾ç¨‹é¡µé¢çš„å…³å¡åˆ—è¡¨
                } else {
                    throw new Error(updateData_result.message || 'ä¿®æ”¹å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // åˆ é™¤å…³å¡
        async function deleteLevel(levelId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…³å¡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/levels/${levelId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadLevelsList();
                    loadLevels(); // åˆ·æ–°åˆ›å»ºè¯¾ç¨‹é¡µé¢çš„å…³å¡åˆ—è¡¨
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadLevels();
            loadCourses();
        });
    </script>
</body>
</html>
