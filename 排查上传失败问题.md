# 排查上传失败 "Failed to fetch" 问题

## 问题描述

上传文件时显示：`上传失败：Failed to fetch。请检查后端服务是否运行在 http://localhost:3000`

## 可能的原因

### 1. 前端环境检测错误

前端可能错误地判断为本地环境，导致使用了 `http://localhost:3000` 而不是 Vercel 后端。

**检查方法**：
1. 打开浏览器控制台（F12）
2. 查看 Console 标签
3. 查找 "当前环境" 和 "API地址" 的日志
4. 确认：
   - 如果显示 "线上生产"，API地址应该是：`https://backend-topaz-zeta-46.vercel.app/api`
   - 如果显示 "本地开发"，说明环境检测有问题

### 2. CORS 跨域问题

虽然后端已配置 CORS，但可能配置不够完善。

**已修复**：我已经更新了 CORS 配置，增加了更详细的设置。

### 3. 网络连接问题

浏览器无法连接到 Vercel 后端。

**检查方法**：
1. 在浏览器中直接访问：`https://backend-topaz-zeta-46.vercel.app/api`
2. 应该能看到 JSON 响应，包含 API 信息
3. 如果无法访问，可能是网络问题

### 4. 文件大小限制

上传的文件可能太大，超过了限制。

**已修复**：我已经将 bodyParser 的限制增加到 50mb。

## 已完成的修复

1. ✅ **改进 CORS 配置**：增加了更详细的 CORS 设置
2. ✅ **增加文件大小限制**：bodyParser 限制增加到 50mb
3. ✅ **改进错误提示**：根据环境显示不同的错误提示
4. ✅ **增加详细日志**：在上传时输出更多调试信息

## 测试步骤

### 1. 清除浏览器缓存

- 按 `Ctrl + Shift + Delete` 清除缓存
- 或按 `F12` → Network → 勾选 "Disable cache"

### 2. 打开浏览器控制台

- 按 `F12` 打开开发者工具
- 切换到 **Console** 标签
- 切换到 **Network** 标签

### 3. 尝试上传文件

1. 访问管理页面
2. 尝试上传一张小图片（小于 1MB）
3. 观察控制台输出：
   - 查看 "当前环境" 和 "API地址"
   - 查看是否有网络请求
   - 查看请求的 URL 是否正确

### 4. 检查 Network 标签

在 Network 标签中：
- 查找上传请求（POST 到 `/api/levels/image`）
- 查看请求状态：
  - ✅ 200：成功
  - ❌ 404：API 地址错误
  - ❌ CORS 错误：跨域问题
  - ❌ Failed to fetch：网络连接问题

## 如果还是失败

请告诉我：

1. **浏览器控制台（Console）显示什么？**
   - "当前环境" 显示什么？
   - "API地址" 显示什么？
   - 有什么错误信息？

2. **Network 标签中显示什么？**
   - 上传请求的状态码是什么？
   - 请求的 URL 是什么？
   - 是否有错误信息？

3. **你是在哪个页面访问的管理页面？**
   - GitHub Pages：`https://wangkainan2021.github.io/ai-course/frontend/admin.html`
   - 还是本地文件？

根据这些信息，我可以更准确地定位问题。
