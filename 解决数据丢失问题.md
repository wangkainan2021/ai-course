# 解决数据丢失问题

## 问题描述

在 Vercel 环境下，上传的关卡数据没过多久就被清空了。

## 原因

**Vercel serverless function 的文件系统是只读的（除了 `/tmp`）**：
- 数据存储在 `/tmp` 目录
- `/tmp` 在 serverless 函数重启后会**丢失**
- 每次部署、函数冷启动、或超时重启都会清空 `/tmp`

## 解决方案

### 已完成的修复

使用 **Vercel Blob Storage** 来持久化 JSON 数据文件：

1. **修改数据读写函数**：
   - `readCourses()` 和 `readLevels()` 现在支持从 Blob Storage 读取
   - `writeCourses()` 和 `writeLevels()` 现在支持写入 Blob Storage

2. **自动切换**：
   - 如果配置了 `BLOB_READ_WRITE_TOKEN`，自动使用 Blob Storage
   - 如果没有配置，回退到本地文件系统（本地开发环境）

3. **数据持久化**：
   - 课程数据存储在：`data/courses.json`（Blob Storage）
   - 关卡数据存储在：`data/levels.json`（Blob Storage）

## 配置要求

### 必须配置 Blob Storage Token

在 Vercel Dashboard 中：

1. 进入项目 `backend-topaz-zeta-46`
2. 进入 **Settings** → **Environment Variables**
3. 添加环境变量：
   - **Name**: `BLOB_READ_WRITE_TOKEN`
   - **Value**: 你的 Blob Storage token（以 `vercel_blob_rw_` 开头）
4. 保存并重新部署

### 如何获取 Blob Storage Token

1. 在 Vercel Dashboard 中
2. 进入 **Storage** → **Blob**
3. 找到你的 Blob Storage
4. 进入 **Settings** → **API Tokens**
5. 复制 `BLOB_READ_WRITE_TOKEN`

## 验证

修复后：

1. ✅ 上传关卡后，数据会持久化到 Blob Storage
2. ✅ 即使 serverless 函数重启，数据也不会丢失
3. ✅ 可以正常读取之前上传的关卡

## 注意事项

### 如果没有配置 Blob Storage Token

- 系统会回退到 `/tmp` 存储
- 数据仍然会在重启后丢失
- **必须配置 Blob Storage Token 才能持久化数据**

### 文件上传

- 图片、视频、代码文件仍然使用 Blob Storage（如果配置了 token）
- 如果没有配置 token，会回退到 `/tmp`（重启后会丢失）

## 下一步

1. **配置 Blob Storage Token**（必须）
2. 推送代码到 GitHub
3. 等待 Vercel 重新部署
4. 测试上传关卡，确认数据不会丢失

## 如果仍然丢失数据

请检查：

1. **Blob Storage Token 是否已配置**：
   - 在 Vercel Dashboard 中检查环境变量
   - 确认 token 名称是 `BLOB_READ_WRITE_TOKEN`

2. **Token 是否有效**：
   - 确认 token 以 `vercel_blob_rw_` 开头
   - 确认 token 没有过期

3. **部署是否成功**：
   - 查看 Vercel 部署日志
   - 确认没有错误信息

4. **数据是否真的写入 Blob Storage**：
   - 在 Vercel Dashboard 中查看 Blob Storage
   - 确认 `data/courses.json` 和 `data/levels.json` 存在
