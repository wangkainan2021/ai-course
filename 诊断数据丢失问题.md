# 诊断数据丢失问题

## 问题

上传的图片关卡没过多久就消失了。

## 可能的原因

### 1. Blob Storage Token 未正确配置

虽然环境变量已添加，但可能：
- Token 值不正确
- Token 没有正确传递到 serverless 函数
- 环境变量作用域不正确

### 2. 写入 Blob Storage 失败但没有报错

- 401 Unauthorized（Token 无效）
- 网络问题
- Blob Storage 服务问题

### 3. 读取时出错，返回了空数组

- 文件不存在（404）
- Token 无效（401）
- 权限问题

## 已添加的调试日志

我已经在代码中添加了详细的日志，包括：

1. **环境检测日志**：
   - `isVercel`: 是否在 Vercel 环境
   - `BLOB_TOKEN 存在`: Token 是否存在
   - `USE_BLOB_STORAGE`: 是否使用 Blob Storage

2. **数据读写日志**：
   - 写入时：记录关卡数量、Blob URL
   - 读取时：记录关卡数量
   - 错误时：记录详细错误信息

3. **API 调用日志**：
   - 每次 API 调用时记录关卡数量

## 检查步骤

### 1. 查看 Vercel 部署日志

1. 在 Vercel Dashboard 中
2. 进入项目 `backend-topaz-zeta-46`
3. 进入 **Deployments** 标签
4. 点击最新的部署
5. 查看 **Function Logs**

查找以下日志：
- `=== 环境检测 ===`
- `USE_BLOB_STORAGE: true/false`
- `写入关卡到 Blob Storage`
- `读取关卡成功，数量: X`

### 2. 检查环境变量

在 Vercel Dashboard 中：
1. 进入 **Settings** → **Environment Variables**
2. 确认 `BLOB_READ_WRITE_TOKEN` 存在
3. 确认作用域是 **All Environments** 或至少包含 **Production**
4. 确认 Token 值正确（以 `vercel_blob_rw_` 开头）

### 3. 测试上传并查看日志

1. 上传一个测试关卡
2. 立即查看 Vercel Function Logs
3. 查找：
   - `准备写入关卡，当前关卡数量: X`
   - `关卡写入完成`
   - `验证：读取关卡数量: X`

### 4. 检查 Blob Storage

在 Vercel Dashboard 中：
1. 进入 **Storage** → **Blob**
2. 找到 `backend-blob`
3. 查看是否有以下文件：
   - `data/courses.json`
   - `data/levels.json`
   - `uploads/images/...`（上传的图片）

## 常见问题

### Q: 日志显示 `USE_BLOB_STORAGE: false`

**原因**：Token 未正确配置或环境检测失败

**解决**：
1. 检查环境变量 `BLOB_READ_WRITE_TOKEN` 是否存在
2. 确认作用域包含 Production
3. 重新部署项目

### Q: 日志显示 `写入关卡到 Blob Storage 失败: 401`

**原因**：Token 无效或过期

**解决**：
1. 在 Blob Storage 设置中重新生成 Token
2. 更新环境变量
3. 重新部署

### Q: 日志显示 `关卡文件不存在，返回空数组`

**原因**：文件从未写入成功，或已被删除

**解决**：
1. 检查写入日志是否有错误
2. 检查 Blob Storage 中是否有文件
3. 重新上传关卡

### Q: 写入成功但读取时返回空数组

**原因**：可能是读取时使用了错误的路径或 Token

**解决**：
1. 检查读取日志中的错误信息
2. 确认 `BLOB_LEVELS_PATH` 和写入时一致
3. 检查 Token 是否一致

## 临时解决方案

如果 Blob Storage 一直有问题，可以：

1. **使用本地后端**：
   - 运行 `cd backend && npm start`
   - 数据会存储在本地文件系统

2. **定期备份数据**：
   - 定期导出 `levels.json` 和 `courses.json`
   - 使用 `/api/init-data` 接口重新导入

## 下一步

1. **推送代码**（包含新的日志）
2. **重新部署** Vercel 项目
3. **上传测试关卡**
4. **查看 Vercel Function Logs**
5. **告诉我日志中的关键信息**：
   - `USE_BLOB_STORAGE` 的值
   - 写入和读取时的关卡数量
   - 任何错误信息

根据日志信息，我可以进一步定位问题。
