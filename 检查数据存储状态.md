# 检查数据存储状态

## 快速诊断

我已经添加了一个诊断 API，可以快速检查数据存储状态。

### 访问诊断 API

在浏览器中访问：
```
https://backend-topaz-zeta-46.vercel.app/api/diagnostic
```

### 诊断信息说明

返回的 JSON 包含以下信息：

#### 1. 环境信息
- `isVercel`: 是否在 Vercel 环境
- `hasBlobToken`: Token 是否存在
- `useBlobStorage`: 是否使用 Blob Storage
- `storageBase`: 存储基础路径

#### 2. 数据状态
- `courses.count`: 课程数量
- `courses.source`: 数据来源（`blob-storage` 或 `local-fs`）
- `levels.count`: 关卡数量
- `levels.source`: 数据来源

#### 3. Blob Storage 状态
- `enabled`: 是否启用
- `tokenConfigured`: Token 是否配置
- `coursesExists`: 课程文件是否存在
- `levelsExists`: 关卡文件是否存在
- `coursesSize`: 课程文件大小（字节）
- `levelsSize`: 关卡文件大小（字节）

## 根据诊断结果判断问题

### 情况 1: `useBlobStorage: false`

**问题**：未使用 Blob Storage，数据存储在 `/tmp`，重启后会丢失。

**解决**：
1. 检查环境变量 `BLOB_READ_WRITE_TOKEN` 是否配置
2. 确认 Token 值正确
3. 重新部署项目

### 情况 2: `useBlobStorage: true` 但 `coursesExists: false` 和 `levelsExists: false`

**问题**：文件从未写入成功。

**解决**：
1. 查看 Vercel Function Logs 中的写入错误
2. 检查 Token 是否有效
3. 尝试重新上传关卡

### 情况 3: `levels.count: 0` 但 `levelsExists: true`

**问题**：文件存在但内容为空或读取失败。

**解决**：
1. 查看读取日志中的错误
2. 检查文件内容是否正确
3. 可能需要重新初始化数据

### 情况 4: 写入成功但读取时数量减少

**问题**：可能是并发写入导致的数据覆盖。

**解决**：
1. 查看写入和读取日志
2. 检查是否有多个写入操作同时进行
3. 考虑添加写入锁机制

## 检查 Vercel Function Logs

1. 在 Vercel Dashboard 中
2. 进入项目 → **Deployments**
3. 点击最新部署 → **Function Logs**
4. 查找以下关键日志：
   - `=== 环境检测 ===`
   - `USE_BLOB_STORAGE: true/false`
   - `写入关卡到 Blob Storage`
   - `关卡写入成功，Blob URL: ...`
   - `验证：读取关卡数量: X`

## 下一步

1. **访问诊断 API**：`https://backend-topaz-zeta-46.vercel.app/api/diagnostic`
2. **查看返回的 JSON**，告诉我：
   - `useBlobStorage` 的值
   - `levels.count` 的值
   - `levelsExists` 的值
   - 任何错误信息
3. **查看 Vercel Function Logs**，告诉我：
   - 上传关卡时的日志
   - 是否有错误信息

根据这些信息，我可以进一步定位问题。
